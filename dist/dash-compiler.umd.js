(function(b,T){typeof exports=="object"&&typeof module!="undefined"?T(exports,require("mc-project-core"),require("path-browserify"),require("molang"),require("bridge-common-utils"),require("json5"),require("@swc/wasm-web"),require("bridge-js-runtime"),require("is-glob")):typeof define=="function"&&define.amd?define(["exports","mc-project-core","path-browserify","molang","bridge-common-utils","json5","@swc/wasm-web","bridge-js-runtime","is-glob"],T):(b=typeof globalThis!="undefined"?globalThis:b||self,T(b.DashCompiler={},b.mcProjectCore,b.pathBrowserify,b.molang,b.bridgeCommonUtils,b.json5,b.wasmWeb,b.bridgeJsRuntime,b.isGlob))})(this,function(b,T,k,O,j,Q,Y,q,Z){"use strict";function N(r){return r&&typeof r=="object"&&"default"in r?r:{default:r}}var A=N(Q),ee=N(Z);class te extends T.ProjectConfig{constructor(e,s){super(k.dirname(s)),this.fileSystem=e,this.configPath=s}readConfig(){return this.fileSystem.readJson(this.configPath)}writeConfig(e){return this.fileSystem.writeJson(this.configPath,e)}}class P{constructor(e,s,t){this.dash=e,this.pluginId=s,this.plugin=t}async runBuildStartHook(){var e,s;try{return await((s=(e=this.plugin).buildStart)==null?void 0:s.call(e))}catch(t){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "buildStart" hook:`,t)}}async runIncludeHook(){var e,s;try{return await((s=(e=this.plugin).include)==null?void 0:s.call(e))}catch(t){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "include" hook:`,t)}}async runTransformPathHook(e){var s,t;try{return await((t=(s=this.plugin).transformPath)==null?void 0:t.call(s,e))}catch(i){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "transformPath" hook for "${e}":`,i)}}async runReadHook(e,s){var t,i;try{return await((i=(t=this.plugin).read)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "read" hook for "${e}":`,n)}}async runLoadHook(e,s){var t,i;try{return await((i=(t=this.plugin).load)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "load" hook for "${e}":`,n)}}async runRegisterAliasesHook(e,s){var t,i;try{return await((i=(t=this.plugin).registerAliases)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "registerAliases" hook for "${e}":`,n)}}async runRequireHook(e,s){var t,i;try{return await((i=(t=this.plugin).require)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "require" hook for "${e}":`,n)}}async runTransformHook(e,s,t){var i,n;try{return await((n=(i=this.plugin).transform)==null?void 0:n.call(i,e,s,t))}catch(a){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "transform" hook for "${e}":`,a)}}async runFinalizeBuildHook(e,s){var t,i;try{return await((i=(t=this.plugin).finalizeBuild)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "finalizeBuild" hook for "${e}":`,n)}}async runBuildEndHook(){var e,s;try{return await((s=(e=this.plugin).buildEnd)==null?void 0:s.call(e))}catch(t){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "buildEnd" hook:`,t)}}}const se=({options:r,outputFileSystem:e,hasComMojangDirectory:s,projectConfig:t,projectRoot:i,packType:n})=>{var u;r.buildName||(r.buildName=r.mode==="development"?"dev":"dist"),r.packName||(r.packName="Bridge"),(u=r.rewriteToComMojang)==null||u||(s=!1);const a={behaviorPack:"development_behavior_packs",resourcePack:"development_resource_packs",skinPack:"skin_packs",worldTemplate:"minecraftWorlds"},c=m=>s&&r.mode==="development"?`${a[m]}`:`${i}/builds/${r.buildName}`,l=(m,d)=>`${c(m)}/${r.packName} ${d}`;return{async buildStart(){if(r.mode==="production"||r.buildType==="fullBuild")if(s)for(const m in a){const d=n.getFromId(m);!d||await e.unlink(l(m,d.defaultPackPath)).catch(()=>{})}else await e.unlink(c("BP")).catch(()=>{})},transformPath(m){if(!m||m.includes("BP/scripts/gametests/")&&r.mode==="production")return;const d=n==null?void 0:n.get(m);if(!d)return;const o=t.getAbsolutePackRoot(d.id),f=k.relative(o,m);if(["behaviorPack","resourcePack","skinPack","worldTemplate"].includes(d.id))return k.join(l(d.id,d.defaultPackPath),f)}}},ie=({fileType:r,projectConfig:e,requestJsonData:s,options:t,console:i,jsRuntime:n})=>{const a=(o,f)=>e.resolvePackPath(o,f),c=new O.CustomMoLang({}),l=o=>o==null?void 0:o.endsWith(".molang"),u=o=>o==null?void 0:o.startsWith(e.resolvePackPath("behaviorPack","scripts/molang/")),m=o=>{var f;return(f=Object.entries(t.include).find(([p])=>(r==null?void 0:r.getId(o))===p))==null?void 0:f[1]};let d=[];return{async buildStart(){t.include=Object.assign(await s("data/packages/minecraftBedrock/location/validMoLang.json"),t.include)},transformPath(o){if(l(o)||u(o))return null},async read(o,f){if((l(o)||u(o))&&f){const p=await f.getFile();return await(p==null?void 0:p.text())}else if(m(o)&&o.endsWith(".json")&&f){const p=await f.getFile();if(!p)return;try{return A.default.parse(await p.text())}catch(w){return t.buildType!=="fileRequest"&&i.error(`Error within file "${o}": ${w}`),{__error__:`Failed to load original file: ${w}`}}}},async load(o,f){if(l(o)&&f)c.parse(f);else if(u(o)){const p=await n.run(o,{console:i},f).catch(w=>(i.error(`Failed to execute Molang AST script "${o}": ${w}`),null));if(!p)return null;typeof p.__default__=="function"&&d.push(p.__default__)}},async require(o){if(m(o))return[a("behaviorPack","scripts/molang/**/*.[jt]s"),a("behaviorPack","molang/**/*.molang"),a("resourcePack","molang/**/*.molang")]},async transform(o,f){const p=m(o);p&&p.length>0&&p.forEach(w=>j.setObjectAt(w,f,h=>{if(typeof h!="string"||h[0]==="/"||h[0]==="@")return h;if(d.length>0){let g=null;try{g=c.parse(h)}catch(F){t.buildType!=="fileRequest"&&i.error(`Error within file "${o}"; script "${h}": ${F}`)}if(g){for(const F of d)g=g.walk(F);h=g.toString()}}try{return c.transform(h)}catch(g){return t.buildType!=="fileRequest"&&i.error(`Error within file "${o}"; script "${h}": ${g}`),h}}))},finalizeBuild(o,f){if(m(o)&&typeof f!="string")return JSON.stringify(f,null,"	")},buildEnd(){d=[]}}},ne=({fileType:r})=>({registerAliases(e,s){var t,i,n,a;if((r==null?void 0:r.getId(e))==="entity"&&((i=(t=s==null?void 0:s["minecraft:entity"])==null?void 0:t.description)==null?void 0:i.identifier))return[(a=(n=s==null?void 0:s["minecraft:entity"])==null?void 0:n.description)==null?void 0:a.identifier]}});function re(r,e){const s=D(r),t=D(e),i=s.pop(),n=t.pop(),a=V(s,t);return a!==0?a:i&&n?V(i.split("."),n.split(".")):i||n?i?-1:1:0}const ae=(r,e,s)=>{ue(s);const t=re(r,e);return z[s].includes(t)},oe=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,D=r=>{if(typeof r!="string")throw new TypeError("Invalid argument expected string");const e=r.match(oe);if(!e)throw new Error(`Invalid argument not valid semver ('${r}' received)`);return e.shift(),e},W=r=>r==="*"||r==="x"||r==="X",J=r=>{const e=parseInt(r,10);return isNaN(e)?r:e},ce=(r,e)=>typeof r!=typeof e?[String(r),String(e)]:[r,e],le=(r,e)=>{if(W(r)||W(e))return 0;const[s,t]=ce(J(r),J(e));return s>t?1:s<t?-1:0},V=(r,e)=>{for(let s=0;s<Math.max(r.length,e.length);s++){const t=le(r[s]||0,e[s]||0);if(t!==0)return t}return 0},z={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]},B=Object.keys(z),ue=r=>{if(typeof r!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof r}`);if(B.indexOf(r)===-1)throw new Error(`Invalid operator, expected one of ${B.join("|")}`)},de=(r,e)=>({register:s=>{var t;((t=s.type)!=null?t:"entity")===e&&(r.component=({name:i,schema:n,template:a})=>{const c=new s;i(s.component_name),n(R(Object.values(c.onPropose())[0])),a((l,{create:u})=>{u(c.onApply(l,"components")[`minecraft:${e}`])})})}});function R(r){const e={},s=Object.keys(r);if(s.length===1&&s[0].startsWith("$dynamic.list."))return{type:"array",items:R(Object.values(r)[0])};for(const[t,i]of Object.entries(r))t.startsWith("$")||(typeof i=="string"?e[t]=he(i):Array.isArray(i)?e[t]={enum:i}:i==="object"&&(e[t]=R(i)));return{type:"object",properties:e}}function he(r){switch(r){case"$general.boolean":return{type:"boolean"};case"$general.number":return{type:"integer"};case"$general.decimal":return{type:"number"};default:return{type:["number","integer","string","boolean","object","array"]}}}class L{constructor(e,s,t,i,n,a){this.console=e,this.fileType=s,this.componentSrc=t,this.mode=i,this.v1Compat=n,this.targetVersion=a,this.animations=[],this.animationControllers=[],this.createOnPlayer=[],this.dialogueScenes={},this.serverFiles=[],this.clientFiles={},this.lifecycleHookCount={activated:0,deactivated:0}}setProjectConfig(e){this.projectConfig=e}get name(){return this._name}async load(e,s,t){let i={component:null};const n=await e.run(s,{defineComponent:u=>u,console:this.console,Bridge:this.v1Compat?de(i,this.fileType):void 0}).catch(()=>(this.console.error(`Failed to execute component ${s}`),null));if(!n)return!1;if(typeof n.__default__!="function")if(i.component)n.__default__=i.component;else return this.console.error(`Component ${s} is not a valid component. Expected a function as the default export.`),!1;const a=u=>this._name=u;let c=u=>this.schema=u,l=()=>{};return(!t||t==="server")&&(c=()=>{},l=u=>{this.template=(m,d)=>{try{u(m,d)}catch(o){this.console.log(u.toString()),this.console.error(o)}}}),await n.__default__({name:a,schema:c,template:l}),!0}reset(){this.animations=[],this.animationControllers=[],this.clientFiles={},this.serverFiles=[]}getSchema(){return this.schema}toString(){return this.componentSrc}create(e,s,t=`minecraft:${this.fileType}`,i){var l;const n=t.split("/"),a=n.pop(),c=this.getObjAtLocation(e,[...n]);c[a]=(i?(u,m)=>i(j.deepMerge,u,m):j.deepMerge)((l=c[a])!=null?l:{},s!=null?s:{})}getObjAtLocation(e,s){let t=e;for(;s.length>0;){const i=s.shift();t[i]===void 0?t[Number(i)]!==void 0?t=t[Number(i)]:(t[i]={},t=t[i]):t=t[i]}return t}async processTemplates(e,s,t){var h,g,F,$,C,S;if(typeof this.template!="function")return;const i=(F=(g=(h=e[`minecraft:${this.fileType}`])==null?void 0:h.description)==null?void 0:g.identifier)!=null?F:"bridge:no_identifier",n=await j.hashString(`${this.name}/${i}`),a=(S=(C=($=this.projectConfig)==null?void 0:$.get())==null?void 0:C.namespace)!=null?S:"bridge",c=(y,v)=>(this.animations.push([y,v]),this.getShortAnimName("a",n,this.animations.length-1)),l=(y,v)=>(this.animationControllers.push([y,v]),this.getShortAnimName("ac",n,this.animationControllers.length-1)),u=y=>{const v=`loot_tables/bridge/${this.getShortAnimName("lt",n,this.serverFiles.length)}.json`;return this.serverFiles.push([v,y]),v},m=y=>{const v=`trading/bridge/${this.getShortAnimName("tt",n,this.serverFiles.length)}.json`;return this.serverFiles.push([v,y]),v},d=y=>{this.serverFiles.push([`recipes/bridge/${this.getShortAnimName("recipe",n,this.serverFiles.length)}.json`,y])},o=y=>{this.serverFiles.push([`spawn_rules/bridge/${this.getShortAnimName("sr",n,this.serverFiles.length)}.json`,y])},f=(await j.hashString(`${this.name}/${t}`)).slice(0,16),p=y=>this.registerLifecycleHook(e,t,y,f,"activated"),w=y=>this.registerLifecycleHook(e,t,y,f,"deactivated");this.fileType==="entity"?this.template(s!=null?s:{},{mode:this.mode,compilerMode:this.mode,sourceEntity:()=>JSON.parse(JSON.stringify(e)),create:(y,v,_)=>this.create(e,y,v,_),location:t,identifier:i,projectNamespace:a,animationController:l,animation:c,lootTable:u,tradeTable:m,spawnRule:o,dialogueScene:!this.targetVersion||ae(this.targetVersion,"1.17.10",">=")?(y,v=!0)=>{this.dialogueScenes[n]||(this.dialogueScenes[n]=[]),this.dialogueScenes[n].push(y),y.scene_tag&&v&&p({run_command:{command:[`/dialogue open @s @p ${y.scene_tag}`]}})}:void 0,onActivated:p,onDeactivated:w,client:{create:(y,v="1.10.0")=>{this.clientFiles[`entity/bridge/${n}.json`]={format_version:v,"minecraft:client_entity":Object.assign({description:{identifier:i}},y)}}}}):this.fileType==="item"?this.template(s!=null?s:{},{mode:this.mode,compilerMode:this.mode,sourceItem:()=>JSON.parse(JSON.stringify(e)),create:(y,v,_)=>this.create(e,y,v,_),location:t,identifier:i,projectNamespace:a,lootTable:u,recipe:d,player:{animationController:l,animation:c,create:(y,v,_)=>this.createOnPlayer.push([v!=null?v:"minecraft:entity",y,_])}}):this.fileType==="block"&&this.template(s!=null?s:{},{mode:this.mode,compilerMode:this.mode,sourceBlock:()=>JSON.parse(JSON.stringify(e)),create:(y,v,_)=>this.create(e,y,v,_),lootTable:u,recipe:d,location:t,identifier:i,projectNamespace:a})}async processAdditionalFiles(e,s){var u,m,d,o,f,p;const t=(m=(u=this.projectConfig)==null?void 0:u.getRelativePackRoot("behaviorPack"))!=null?m:"BP",i=(d=this.projectConfig)==null?void 0:d.getRelativePackRoot("resourcePack"),n=(p=(f=(o=s[`minecraft:${this.fileType}`])==null?void 0:o.description)==null?void 0:f.identifier)!=null?p:"bridge:no_identifier",a=await j.hashString(`${this.name}/${n}`),c=`${t}/animations/bridge/${a}.json`,l=`${t}/animation_controllers/bridge/${a}.json`;return n==="minecraft:player"&&this.createOnPlayer.forEach(([w,h,g])=>{this.create(s,h,w,g)}),i||(this.clientFiles={},this.console.error(`[${this.name}] Dash was unable to load the root of your resource pack and therefore cannot generate client files for this component.`)),{[c]:{baseFile:e,fileContent:this.createAnimations(a,s)},[l]:{baseFile:e,fileContent:this.createAnimationControllers(a,s)},[k.join(t,`dialogue/bridge/${a}.json`)]:this.dialogueScenes[a]&&this.dialogueScenes[a].length>0?{baseFile:e,fileContent:JSON.stringify({format_version:this.targetVersion,"minecraft:npc_dialogue":{scenes:this.dialogueScenes[a]}},null,"	")}:void 0,...Object.fromEntries(this.serverFiles.map(([w,h])=>[k.join(t,w),{baseFile:e,fileContent:JSON.stringify(h,null,"	")}])),...Object.fromEntries(Object.entries(this.clientFiles).map(([w,h])=>[k.join(i,w),{baseFile:e,fileContent:JSON.stringify(h,null,"	")}]))}}createAnimations(e,s){if(this.animations.length===0)return;let t=0;const i={format_version:"1.10.0",animations:{}};for(const[n,a]of this.animations){if(!n){t++;continue}const c=this.getAnimName("animation",e,t),l=this.getShortAnimName("a",e,t);i.animations[c]=n,this.create(s,{animations:{[l]:c}},"minecraft:entity/description"),a!==!1&&this.create(s,{scripts:{animate:[a?{[l]:a}:l]}},"minecraft:entity/description"),t++}return JSON.stringify(i,null,"	")}createAnimationControllers(e,s){if(this.animationControllers.length===0)return;let t=0;const i={format_version:"1.10.0",animation_controllers:{}};for(const[n,a]of this.animationControllers){if(!n){t++;continue}const c=this.getAnimName("controller.animation",e,t),l=this.getShortAnimName("ac",e,t);i.animation_controllers[c]=n,this.create(s,{animations:{[l]:c}},"minecraft:entity/description"),a!==!1&&this.create(s,{scripts:{animate:[a?{[l]:a}:l]}},"minecraft:entity/description"),t++}return JSON.stringify(i,null,"	")}getAnimName(e,s,t){return`${e}.${s}_${t}`}getShortAnimName(e,s,t){var i;return`${(i=s.slice(0,16))!=null?i:"bridge_auto"}_${e}_${t}`}registerLifecycleHook(e,s,t,i,n){e[`minecraft:${this.fileType}`].events||(e[`minecraft:${this.fileType}`].events={});const a=e[`minecraft:${this.fileType}`].events;if(n==="activated"&&s===`minecraft:${this.fileType}/components`)a["minecraft:entity_spawned"]||(a["minecraft:entity_spawned"]={}),this.addEventReponse(a["minecraft:entity_spawned"],t);else if(this.fileType==="entity"&&s.startsWith(`minecraft:${this.fileType}/component_groups/`)){const c=s.split("/").pop();this.findComponentGroupReferences(a,n==="activated"?"add":"remove",c).forEach(u=>this.addEventReponse(u,t))}else if(s.startsWith(`minecraft:${this.fileType}/permutations/`)){const c=s.split("/");if(c.pop()!=="components")throw new Error("Invalid component location inside of permutation");const l=this.getObjAtLocation(e,[...c]),u=`bridge:${i}_${n}_${n==="activated"?this.lifecycleHookCount.activated++:this.lifecycleHookCount.deactivated++}`;l.condition&&this.animationControllers.push([{states:{default:{on_entry:[`@s ${u}`]}}},n==="activated"?l.condition:`!(${l.condition})`]),a[u]=t}}addEventReponse(e,s){if(Array.isArray(e.sequence))e.sequence.push(s);else if(Object.keys(e).length===0)Object.assign(e,s);else{let t=Object.assign({},e,{filters:void 0});for(const i in e)i!=="filters"&&(e[i]=void 0);e.sequence=[t,s]}}findComponentGroupReferences(e,s,t){var n,a;let i=[];for(const c in e){const l=e[c];Array.isArray(l.sequence)?i.push(...this.findComponentGroupReferences(l.sequence,s,t)):Array.isArray(l.randomize)?i.push(...this.findComponentGroupReferences(l.randomize,s,t)):((a=(n=l[s])==null?void 0:n.component_groups)!=null?a:[]).includes(t)&&i.push(l)}return i}}function fe(r){const e=[];for(const[s,t]of r)e.push(...me(t,s));return e}function me(r,e){const s=[];for(const t in r)t.startsWith("minecraft:")||t.startsWith("tag:")||s.push([t,e]);return s}function E({fileType:r,getComponentObjects:e}){const s=new Map;let t={};return({console:i,projectConfig:n,projectRoot:a,compileFiles:c,getAliases:l,options:u,jsRuntime:m,targetVersion:d,fileType:o})=>{const f=(h,g)=>h&&r==="item"&&(o==null?void 0:o.getId(h))==="entity"&&g(h).includes("minecraft:player"),p=h=>u.v1CompatMode?h==null?void 0:h.includes("/components/"):h&&(o==null?void 0:o.getId(h))==="customComponent"&&h.includes(`/${r}/`),w=h=>h&&(o==null?void 0:o.getId(h))===r;return{buildStart(){s.clear(),t={}},transformPath(h){if(p(h)&&u.buildType!=="fileRequest")return null},async read(h,g){if(!g)return t[h]?A.default.parse(t[h].fileContent):void 0;if(p(h)&&h.endsWith(".js")){const F=await g.getFile();return await(F==null?void 0:F.text())}else if(w(h)||f(h,l)){const F=await g.getFile();if(!F)return;try{return A.default.parse(await F.text())}catch($){return u.buildType!=="fileRequest"&&i.error(`Error within file "${h}": ${$}`),{__error__:`Failed to load original file: ${$}`}}}},async load(h,g){if(p(h)&&typeof g=="string"){const F=new L(i,r,g,u.mode,!!u.v1CompatMode,d);return F.setProjectConfig(n),await F.load(m,h)?F:g}},async registerAliases(h,g){if(p(h))return[`${r}Component#${g.name}`]},async require(h,g){if(f(h,l))return[`.${n.getRelativePackRoot("behaviorPack")}/components/item/**/*.[jt]s`,`.${n.getRelativePackRoot("behaviorPack")}/items/**/*.json`];if(w(h)){const F=fe(e(g));return s.set(h,F),F.map($=>`${r}Component#${$[0]}`)}else if(t[h])return[t[h].baseFile]},async transform(h,g,F={}){var $;if(f(h,l)){const C=Object.entries(F).filter(([S])=>S.startsWith("itemComponent#")).map(([S,y])=>y);for(const S of C){if(!S)return;t=j.deepMerge(t,await S.processAdditionalFiles(h,g))}}else if(w(h)){const C=new Set;for(const[S,y]of($=s.get(h))!=null?$:[]){const v=F[`${r}Component#${S}`];if(!v)continue;const _=j.get(g,y.split("/"),{}),Me=_[S];delete _[S],await v.processTemplates(g,Me,y),C.add(v)}for(const S of C)t=j.deepMerge(t,await S.processAdditionalFiles(h,g));for(const S of C)S.reset()}},finalizeBuild(h,g){if(p(h)&&g)return g.toString();if(w(h)||t[h])return JSON.stringify(g,null,"	")},async buildEnd(){if(u.buildType==="fileRequest")return;t=Object.fromEntries(Object.entries(t).filter(([g,F])=>(F==null?void 0:F.fileContent)!==void 0).map(([g,F])=>[k.join(a,g),F]));const h=Object.keys(t);h.length>0&&await c(h),t={}}}}}const pe=E({fileType:"entity",getComponentObjects:r=>{var e,s,t,i,n,a;return[["minecraft:entity/components",(s=(e=r==null?void 0:r["minecraft:entity"])==null?void 0:e.components)!=null?s:{}],...Object.entries((i=(t=r==null?void 0:r["minecraft:entity"])==null?void 0:t.component_groups)!=null?i:{}).map(([c,l])=>[`minecraft:entity/component_groups/${c}`,l]),...((a=(n=r==null?void 0:r["minecraft:entity"])==null?void 0:n.permutations)!=null?a:[]).map((c,l)=>{var u;return[`minecraft:entity/permutations/${l}/components`,(u=c==null?void 0:c.components)!=null?u:{}]})]}}),ge=E({fileType:"item",getComponentObjects:r=>{var e,s;return[["minecraft:item/components",(s=(e=r==null?void 0:r["minecraft:item"])==null?void 0:e.components)!=null?s:{}]]}}),ye=E({fileType:"block",getComponentObjects:r=>{var e,s,t,i;return[["minecraft:block/components",(s=(e=r==null?void 0:r["minecraft:block"])==null?void 0:e.components)!=null?s:{}],...((i=(t=r==null?void 0:r["minecraft:block"])==null?void 0:t.permutations)!=null?i:[]).map((n,a)=>{var c;return[`minecraft:block/permutations/${a}/components`,(c=n.components)!=null?c:{}]})]}});function M(r,e,s,t=0){const i=[];for(const n of r){if(!n.startsWith("/")){i.push(n);continue}const[a,...c]=j.tokenizeCommand(n.slice(1)).tokens.map(({word:u})=>u),l=e[`command#${a}`];if(a==="execute"){let u=4;if(c[u]==="detect"&&(u+=6),c[u]===void 0){i.push(n);continue}const[m,...d]=c.slice(u),o=e[`command#${m}`];if(!(o instanceof I)){i.push(n);continue}i.push(...o.process(`${m} ${d.join(" ")}`,e,t+1).map(f=>f.startsWith("/")?`/execute ${c.slice(0,u).join(" ")} ${f.slice(1)}`:f));continue}else if(!(l instanceof I)){i.push(n);continue}i.push(...l.process(n,e,t))}return i.filter(n=>s||!n.startsWith("#")).map(n=>n.trim())}const we=r=>({register:e=>{r.command=({name:s,schema:t,template:i})=>{s(e.command_name),t([]),i(n=>new e().onApply(n))}}});class I{constructor(e,s,t,i){this.console=e,this.commandSrc=s,this.mode=t,this.v1Compat=i}get name(){var e;return(e=this._name)!=null?e:"unknown"}async load(e,s,t){const i={command:null},n=await e.run(s,{console:this.console,defineCommand:u=>u,Bridge:this.v1Compat?we(i):void 0}).catch(u=>(this.console.error(`Failed to execute command ${this.name}: ${u}`),null));if(!n)return null;if(typeof n.__default__!="function")if(i.command)n.__default__=i.command;else return this.console.error(`Component ${s} is not a valid component. Expected a function as the default export.`),!1;const a=u=>this._name=u;let c=u=>this.schema=u,l=()=>{};(!t||t==="server")&&(c=()=>{},l=u=>{this.template=(m,d)=>{try{return u(m,d)}catch(o){return this.console.error(o),[]}}}),await n.__default__({name:a,schema:c,template:l})}process(e,s,t){var l;e.startsWith("/")&&(e=e.slice(1));const[i,...n]=j.tokenizeCommand(e).tokens.map(({word:u})=>u),a=(l=this.template)==null?void 0:l.call(this,n.map(u=>j.castType(u)),{compilerMode:this.mode,commandNestingDepth:t,compileCommands:u=>M(u.map(m=>m.startsWith("/")?m:`/${m}`),s,!1,t+1).map(m=>m.startsWith("/")?m.slice(1):m)});let c=[];if(typeof a=="string")c=a.split(`
`);else if(Array.isArray(a))c=a.filter(u=>typeof u=="string");else{const u=`Failed to process command ${this._name}; Invalid command template return type: Expected string[] or string, received ${typeof a}`;this.console.error(u),c.push(`# ${u}`)}return c.map(u=>u.startsWith("/")||u.startsWith("#")?u:`/${u}`)}getSchema(){if(this.schema){if(Array.isArray(this.schema))return this.schema.length===0?[{commandName:this.name}]:this.schema.map(e=>({commandName:this.name,...e}))}else return[{commandName:this.name}];return this.schema.commandName||(this.schema.commandName=this.name),[this.schema]}toString(){return this.commandSrc}}const Fe=({projectConfig:r,jsRuntime:e,console:s,fileType:t,requestJsonData:i,options:n})=>{const a=(d,o)=>r.resolvePackPath(d,o),c=d=>d&&t.getId(d)==="customCommand",l=d=>d&&t.getId(d)==="function",u=d=>{var o;return(o=Object.entries(n.include).find(([f])=>t.getId(d)===f))==null?void 0:o[1]},m=d=>{var o,f,p;return(p=(f=(o=t.get(d))==null?void 0:o.meta)==null?void 0:f.commandsUseSlash)!=null?p:!1};return{async buildStart(){n.include=Object.assign(await i("data/packages/minecraftBedrock/location/validCommand.json"),n.include)},transformPath(d){if(c(d)&&n.buildType!=="fileRequest")return null},async read(d,o){if(!!o){if(c(d)&&d.endsWith(".js")){const f=await o.getFile();return await(f==null?void 0:f.text())}else if(l(d)){const f=await o.getFile();return await(f==null?void 0:f.text())}else if(u(d)&&o){const f=await o.getFile();if(!f)return;try{return A.default.parse(await f.text())}catch(p){s.error(p)}}}},async load(d,o){var f;if(c(d)){const p=new I(s,o,n.mode,(f=n.v1CompatMode)!=null?f:!1);return await p.load(e,d),p}},async registerAliases(d,o){if(c(d))return[`command#${o.name}`]},async require(d){if(u(d)||l(d))return[a("behaviorPack","commands/**/*.[jt]s"),a("behaviorPack","commands/*.[jt]s")]},async transform(d,o,f={}){const p=u(d);if(p&&p.length>0){const w=m(d);p.forEach(h=>j.setObjectAt(h,o,g=>{if(!g)return g;g=Array.isArray(g)?g:[g];const F=[];for(const $ of g){if(typeof $=="string"){F.push($);continue}s.error(`The file "${d}" contains invalid commands. Expected type "string" within array but got type "${typeof $}"`)}return M(F.map($=>!w&&!$.startsWith("/")?`/${$}`:$),f,!1).map($=>w?$:$.slice(1))}))}else if(l(d)){const w=o.split(`
`).map(h=>h.trim()).filter(h=>h!==""&&!h.startsWith("#")).map(h=>`/${h}`);return M(w,f,!0).map(h=>h.startsWith("/")?h.slice(1):h).join(`
`)}},finalizeBuild(d,o){if(c(d)&&o)return o.toString();if(u(d)&&typeof o!="string")return JSON.stringify(o,null,"	")}}},ve=({options:r})=>({async transformPath(e){if(!!(e!=null&&e.endsWith(".ts")))return`${e.slice(0,-3)}.js`},async read(e,s){if(!e.endsWith(".ts")||!s)return;const t=await s.getFile();return await(t==null?void 0:t.text())},async load(e,s){if(!!e.endsWith(".ts"))return await q.loadedWasm,Y.transformSync(s,{filename:k.basename(e),sourceMaps:r!=null&&r.inlineSourceMap?"inline":void 0,jsc:{parser:{syntax:"typescript"},target:"es2020"}}).code},finalizeBuild(e,s){if(e.endsWith(".ts")&&typeof s=="string")return s}}),ke=({options:r,outputFileSystem:e,projectRoot:s,packType:t,fileType:i,console:n})=>{r.packName||(r.packName="bridge project");const a=m=>m.split(/\\|\//g).filter(d=>d!==".."&&d!==".").slice(1).join("/"),c=m=>{const d=t.getId(m),o=k.relative(s,m);if(d==="behaviorPack"||d==="resourcePack"||d==="skinPack")return k.join(s,"builds/dist",d,a(o))},l=m=>{const d=t.getId(m),o=k.relative(s,m);if(d==="worldTemplate")return k.join(s,"builds/dist",a(o));if(d==="behaviorPack"||d==="resourcePack")return k.join(s,"builds/dist",d==="behaviorPack"?"behavior_packs":"resource_packs",r.packName,a(o))},u=m=>i.getId(m)==="worldManifest"?null:l(m);return{async buildStart(){await e.unlink(`${s}/builds/dist`).catch(()=>{})},transformPath(m){if(!!m)switch(r.format){case"mcaddon":return c(m);case"mcworld":return u(m);case"mctemplate":return l(m);default:n.error(`Unknown packaging format: ${r.format}`)}}}},$e=({projectConfig:r,packType:e,options:s})=>{const t=Object.keys(r.getAvailablePacks()),i=Object.fromEntries(t.map(a=>[a,[]])),n=a=>{const c=e.getId(a);if(c!=="unknown")return[c,r.resolvePackPath(c,"contents.json")]};return s.buildType!=="fullBuild"?{}:{include(){return t.map(a=>[r.resolvePackPath(a,"contents.json"),{isVirtual:!0}])},read(a){const c=n(a);if(!c)return;const[l,u]=c;if(a!==u)return i[l]},transformPath(a){if(!a)return;const c=e.getId(a);c!=="unknown"&&i[c].push(a)},finalizeBuild(a){const c=n(a);if(!c)return;const[l,u]=c;if(a!==u)return JSON.stringify(i[l])}}},be=({fileType:r})=>{const e=[];for(const t of r.all)t.formatVersionMap&&e.push(t.id);const s=t=>t&&e.includes(r.getId(t));return{async read(t,i){if(!!i&&s(t)){const n=await i.getFile();if(!n)return;try{return A.default.parse(await n.text())}catch(a){console.error(a)}}},load(t,i){if(s(t))return i},transform(t,i){if(s(t)){const n=r.get(t),a=n==null?void 0:n.formatVersionMap;if(!a)return;const c=i==null?void 0:i.format_version;return c&&a[c]&&(i.format_version=a[c]),i}},finalizeBuild(t,i){if(s(t))return JSON.stringify(i)}}};class x{constructor(e){this.console=e,this.files=new Map}get hasFiles(){return this.files.size>0}getAll(){return[...this.files.entries()]}get(e){return this.files.get(e)}clear(){this.files.clear()}add(e,s){if(this.files.has(e)){this.console.warn(`Omitting file "${e}" from collection because it would overwrite a previously generated file!`);return}this.files.set(e,s)}addFrom(e){for(const[s,t]of e.getAll())this.add(s,t)}}function Se({generatorPath:r,omitUsedTemplates:e,fileSystem:s,console:t}){return{useTemplate:(i,n=!0)=>{const a=k.join(k.dirname(r),i);return n&&e.add(a),i.endsWith(".json")?s.readJson(a):s.readFile(a).then(c=>c.text())},createCollection:()=>new x(t)}}const je=({fileType:r,console:e,jsRuntime:s,fileSystem:t,compileFiles:i})=>{const n=new Set(["gameTest","customCommand","customComponent"]),a=o=>r.getId(o),c=o=>{var p;const f=r.get(o);return f?(p=f.type)!=null?p:"json":"raw"},l=o=>!n.has(a(o))&&(o.endsWith(".js")||o.endsWith(".ts")),u=o=>{var p,w,h,g;return c(o)==="json"?".json":(g=(h=(w=(p=r.get(o))==null?void 0:p.detect)==null?void 0:w.fileExtensions)==null?void 0:h[0])!=null?g:".txt"},m=new Set,d=new x(e);return{buildStart(){d.clear(),m.clear()},transformPath(o){if(o&&l(o))return o.replace(/\.(js|ts)$/,u(o))},async read(o,f){if(l(o)&&f){const w=await f.getFile();return w?w.text():void 0}const p=d.get(o);if(p)return p},async load(o,f){if(s.registerModule("@bridge/generate",Se({generatorPath:o,fileSystem:t,omitUsedTemplates:m,console:e})),l(o)){if(!f)return null;const p=await s.run(o,{console:e},f).catch(w=>(e.error(`Failed to execute generator script "${o}": ${w}`),null));return p?p.__default__?p.__default__:(e.error(`Expected generator script "${o}" to provide file content as default export!`),null):null}if(d.get(o))return o.endsWith(".json")&&typeof f!="string"?JSON.stringify(f,null,"	"):f},finalizeBuild(o,f){if(m.has(o))return null;if(l(o))return f===null?null:f instanceof x?(d.addFrom(f),null):typeof f=="object"?JSON.stringify(f):f},async buildEnd(){s.deleteModule("@bridge/generate"),d.hasFiles&&await i(d.getAll().map(([o])=>o))}}};class G extends q.Runtime{constructor(e,s){super(s),this.fs=e}readFile(e){return this.fs.readFile(e).then(s=>s.text())}deleteModule(e){this.baseModules.delete(e)}}const U={simpleRewrite:se,rewriteForPackaging:ke,moLang:ie,entityIdentifierAlias:ne,customEntityComponents:pe,customItemComponents:ge,customBlockComponents:ye,customCommands:Fe,typeScript:ve,contentsFile:$e,formatVersionCorrection:be,generatorScripts:je};class _e{constructor(e){this.dash=e,this.plugins=[],this.pluginRuntime=new G(this.dash.fileSystem)}async loadPlugins(e={}){var n,a;this.plugins=[],this.pluginRuntime.clearCache();const s=[...(await this.dash.fileSystem.readdir(k.join(this.dash.projectRoot,".bridge/extensions")).catch(()=>[])).map(c=>c.kind==="directory"?k.join(this.dash.projectRoot,".bridge/extensions",c.name):void 0),...(await this.dash.fileSystem.readdir("extensions").catch(()=>[])).map(c=>c.kind==="directory"?k.join("extensions",c.name):void 0)],t={};for(const c of s){if(!c)continue;let l;try{l=await this.dash.fileSystem.readJson(k.join(c,"manifest.json"))}catch{continue}if(!!((n=l==null?void 0:l.compiler)!=null&&n.plugins))for(const u in l.compiler.plugins)t[u]=k.join(c,l.compiler.plugins[u])}const i=(a=(await this.getCompilerOptions()).plugins)!=null?a:[];for(const c of i){const l=typeof c=="string"?c:c[0],u=typeof c=="string"?{}:c[1];if(t[l]){const m=await this.pluginRuntime.run(t[l],{console:this.dash.console,...e}).catch(d=>(this.dash.console.error(`Failed to execute plugin ${l}: ${d}`),null));if(!m)continue;typeof m.__default__=="function"?this.plugins.push(new P(this.dash,l,m.__default__(await this.getPluginContext(l,u)))):this.dash.console.error(`Plugin ${l} is invalid: It does not provide a function as a default export.`)}else U[l]?this.plugins.push(new P(this.dash,l,U[l](await this.getPluginContext(l,u)))):this.dash.console.error(`Unknown compiler plugin: ${l}`)}}async getCompilerOptions(){var s;const e=await this.dash.getCompilerConfigPath();return e?await this.dash.fileSystem.readJson(e):(s=this.dash.projectConfig.get().compiler)!=null?s:{}}async getPluginContext(e,s={}){const t=this.dash;return{options:{get mode(){return t.getMode()},get buildType(){return t.buildType},...s},jsRuntime:this.dash.jsRuntime,console:this.dash.console,fileSystem:this.dash.fileSystem,outputFileSystem:this.dash.outputFileSystem,projectConfig:this.dash.projectConfig,projectRoot:this.dash.projectRoot,packType:this.dash.packType,fileType:this.dash.fileType,targetVersion:this.dash.projectConfig.get().targetVersion,requestJsonData:this.dash.requestJsonData,getAliases:i=>{var n,a;return[...(a=(n=this.dash.includedFiles.get(i))==null?void 0:n.aliases)!=null?a:[]]},hasComMojangDirectory:this.dash.fileSystem!==this.dash.outputFileSystem,compileFiles:i=>this.dash.compileVirtualFiles(i)}}async runBuildStartHooks(){for(const e of this.plugins)await e.runBuildStartHook()}async runIncludeHooks(){let e=[];for(const s of this.plugins){const t=await s.runIncludeHook();Array.isArray(t)&&e.push(...t)}return e}async runTransformPathHooks(e){let s=e;for(const t of this.plugins){const i=await t.runTransformPathHook(s);if(i===null)return null;i!==void 0&&(s=i)}return s}async runReadHooks(e,s){for(const t of this.plugins){const i=await t.runReadHook(e,s);if(i!=null)return i}}async runLoadHooks(e,s){let t=s;for(const i of this.plugins){const n=await i.runLoadHook(e,t);n!==void 0&&(t=n)}return t}async runRegisterAliasesHooks(e,s){const t=new Set;for(const i of this.plugins){const n=await i.runRegisterAliasesHook(e,s);n!=null&&(Array.isArray(n)?n.forEach(a=>t.add(a)):t.add(n))}return t}async runRequireHooks(e,s){const t=new Set;for(const i of this.plugins){const n=await i.runRequireHook(e,s);n!=null&&(Array.isArray(n)?n.forEach(a=>t.add(a)):t.add(n))}return t}async runTransformHooks(e){const s=Object.fromEntries([...e.requiredFiles].map(i=>this.dash.includedFiles.query(i)).flat().map(i=>[[i.filePath,i.data],...[...i.aliases].map(n=>[n,i.data])]).flat());let t=e.data;for(const i of this.plugins){const n=await i.runTransformHook(e.filePath,t,s);n!==void 0&&(t=n)}return t}async runFinalizeBuildHooks(e){for(const s of this.plugins){const t=await s.runFinalizeBuildHook(e.filePath,e.data);if(t!==void 0)return t}}async runBuildEndHooks(){for(const e of this.plugins)await e.runBuildEndHook()}}class H{constructor(e,s,t=!1){this.dash=e,this.filePath=s,this.isVirtual=t,this.isDone=!1,this.requiredFiles=new Set,this.aliases=new Set,this.updateFiles=new Set,this.outputPath=s,this.isVirtual||this.setDefaultFileHandle()}setFileHandle(e){this.fileHandle=e}setDefaultFileHandle(){this.setFileHandle({getFile:()=>this.dash.fileSystem.readFile(this.filePath).catch(()=>null)})}setOutputPath(e){this.outputPath=e}setReadData(e){this.data=e}setAliases(e){for(const s of e)this.dash.includedFiles.addAlias(s,this);this.aliases=e}setRequiredFiles(e){this.requiredFiles=e}setUpdateFiles(e){this.updateFiles=new Set(e.map(s=>this.dash.includedFiles.get(s)).filter(s=>s!==void 0))}addUpdateFile(e){this.updateFiles.add(e)}removeUpdateFile(e){this.updateFiles.delete(e)}getHotUpdateChain(){const e=new Set([this]);for(const s of this.updateFiles)s.getHotUpdateChain().forEach(t=>{e.add(t)});return e}filesToLoadForHotUpdate(e=new Set,s=!0){const t=new Set;if(e.has(this))return t;e.add(this);for(const i of this.requiredFiles){const n=this.dash.includedFiles.query(i);for(const a of n)a.filesToLoadForHotUpdate(e,!1).forEach(c=>{t.add(c)})}if(t.add(this),s)for(const i of this.updateFiles)i.filesToLoadForHotUpdate(e,!0).forEach(n=>{t.add(n)});return t}async processAfterLoad(e){if((this.data===null||this.data===void 0)&&(this.isDone=!0,this.filePath!==this.outputPath&&this.outputPath!==null&&!this.isVirtual&&e)){const s=await this.dash.fileSystem.readFile(this.filePath);await this.dash.outputFileSystem.writeFile(this.outputPath,new Uint8Array(await s.arrayBuffer()))}}serialize(){return{isVirtual:this.isVirtual,filePath:this.filePath,aliases:[...this.aliases],requiredFiles:[...this.requiredFiles],updateFiles:[...this.updateFiles].map(e=>e.filePath)}}reset(){this.isDone=!1,this.data=null,this.isVirtual||this.setDefaultFileHandle()}}class Ce{constructor(e){this.dash=e,this.files=new Map,this.aliases=new Map,this.queryCache=new Map}all(){return[...this.files.values()]}filtered(e){return this.all().filter(s=>e(s))}get(e){var s;return(s=this.aliases.get(e))!=null?s:this.files.get(e)}query(e){if(ee.default(e))return this.queryGlob(e);const s=this.aliases.get(e);if(s)return[s];const t=this.files.get(e);return t?[t]:[]}addAlias(e,s){this.aliases.set(e,s)}queryGlob(e){if(this.queryCache.has(e))return this.queryCache.get(e);const s=this.filtered(t=>j.isMatch(t.filePath,e));return this.queryCache.set(e,s),s}async loadAll(){this.queryCache=new Map;const e=new Set,s=this.dash.projectConfig.getAvailablePackPaths();for(const i of s){const n=await this.dash.fileSystem.allFiles(i).catch(a=>(this.dash.console.warn(a),[]));for(const a of n)e.add(a)}const t=await this.dash.plugins.runIncludeHooks();for(const i of t)typeof i=="string"?e.add(i):this.addOne(i[0],i[1].isVirtual);this.add([...e])}addOne(e,s=!1){const t=new H(this.dash,e,s);return this.files.set(e,t),t}add(e,s=!1){let t=[];for(const i of e){const n=this.files.get(i);if(n){t.push(n);continue}t.push(new H(this.dash,i,s)),this.files.set(i,t[t.length-1])}return t}remove(e){const s=this.files.get(e);if(!!s){this.files.delete(e);for(const t of s.aliases)this.aliases.delete(t)}}async save(e){await this.dash.fileSystem.writeJson(e,this.all().map(s=>s.serialize()))}async load(e){this.removeAll();const s=await this.dash.fileSystem.readJson(e),t=[];for(const i of s){const n=new H(this.dash,i.filePath,i.isVirtual);n.setAliases(new Set(i.aliases)),n.setRequiredFiles(new Set(i.requiredFiles)),t.push(n);for(const a of i.aliases)this.aliases.set(a,n)}this.files=new Map(t.map(i=>[i.filePath,i]));for(let i=0;i<t.length;i++)t[i].setUpdateFiles(s[i].updateFiles)}resetAll(){for(const e of this.all())e.reset()}removeAll(){this.files=new Map,this.aliases=new Map,this.queryCache=new Map}}class Ae{constructor(e){this.dash=e}async run(e,s=!0){for(const t of e)t.isDone||await this.loadFile(t,s);for(const t of e)t.isDone||await this.loadRequiredFiles(t)}async loadFile(e,s=!0){var a;const[t,i]=await Promise.all([this.dash.plugins.runTransformPathHooks(e.filePath),this.dash.plugins.runReadHooks(e.filePath,e.fileHandle)]);if(e.setOutputPath(t),e.setReadData(i),await e.processAfterLoad(s),e.isDone)return;e.setReadData((a=await this.dash.plugins.runLoadHooks(e.filePath,e.data))!=null?a:e.data);const n=await this.dash.plugins.runRegisterAliasesHooks(e.filePath,e.data);e.setAliases(n)}async loadRequiredFiles(e){const s=await this.dash.plugins.runRequireHooks(e.filePath,e.data);e.setRequiredFiles(s)}}class Te{constructor(e){this.dash=e}run(e){const s=new Set;for(const t of e)t.isDone||s.has(t)||this.resolveSingle(t,s);return s}resolveSingle(e,s,t=new Set){const i=this.dash.includedFiles;t.add(e);for(const n of e.requiredFiles){const a=i.query(n);for(const c of a){if(!c){this.dash.console.error(`Undefined file dependency: "${e.filePath}" requires "${n}"`);continue}if(c.addUpdateFile(e),!s.has(c)){if(t.has(c)){this.dash.console.error(`Circular dependency detected: ${c.filePath} is required by ${e.filePath} but also depends on this file.`);continue}this.resolveSingle(c,s,t)}}}s.add(e),t.delete(e)}}function Oe(r){return typeof r=="string"||r instanceof Blob||r instanceof File||r instanceof ArrayBuffer||(r==null?void 0:r.buffer)instanceof ArrayBuffer}class Ie{constructor(e){this.dash=e}async run(e,s=!1){for(const t of e){if(t.isDone)continue;let i=await this.transformFile(t,!0,s);i!=null&&t.outputPath&&await this.dash.outputFileSystem.writeFile(t.outputPath,i)}}async transformFile(e,s=!1,t=!1){var n;if(t||(e.data=(n=await this.dash.plugins.runTransformHooks(e))!=null?n:e.data),!s)return e.data;let i=await this.dash.plugins.runFinalizeBuildHooks(e);return i===void 0&&(i=e.data),i!=null&&(Oe(i)||(this.dash.console.warn(`File "${e.filePath}" was not in a writable format: "${typeof i}". Trying to JSON.stringify(...) it...`,i),i=JSON.stringify(i))),e.isDone=!0,i}}class qe{constructor(e=1){this.total=e,this.current=0,this.onChangeCbs=new Set}get percentage(){return this.current/this.total}onChange(e){return this.onChangeCbs.add(e),{dispose:()=>this.onChangeCbs.delete(e)}}setTotal(e){this.total=e,this.current=0,this.onChangeCbs.forEach(s=>s(this))}updateCurrent(e){this.current=e,this.onChangeCbs.forEach(s=>s(this))}advance(){this.current++,this.onChangeCbs.forEach(e=>e(this))}addToTotal(e){this.total+=e,this.onChangeCbs.forEach(s=>s(this))}}class K{constructor(){this._timers=new Map}time(e){if(this._timers.has(e)){this.warn(`Timer "${e}" already exists.`);return}else this._timers.set(e,Date.now())}timeEnd(e){const s=this._timers.get(e);if(s)this._timers.delete(e),this.log(`${e}: ${Date.now()-s}ms`);else{this.warn(`Timer "${e}" does not exist.`);return}}}class X extends K{log(...e){console.log(...e)}error(...e){console.error(...e)}warn(...e){console.warn(...e)}info(...e){console.info(...e)}}class Re{constructor(e,s,t){var i;this.fileSystem=e,this.options=t,this.progress=new qe,this.plugins=new _e(this),this.includedFiles=new Ce(this),this.loadFiles=new Ae(this),this.fileOrderResolver=new Te(this),this.fileTransformer=new Ie(this),this.buildType="fullBuild",this.outputFileSystem=s!=null?s:e,this.projectRoot=k.dirname(t.config),this.projectConfig=new te(e,t.config),this.console=(i=t.console)!=null?i:new X,this.jsRuntime=new G(this.fileSystem,[["@molang/expressions",O.expressions],["@molang/core",{MoLang:O.MoLang}],["molang",{MoLang:O.MoLang,...O.expressions}],["@bridge/compiler",{mode:t.mode}]]),this.packType=t.packType,this.fileType=t.fileType}getMode(){var e;return(e=this.options.mode)!=null?e:"development"}getCompilerConfigPath(){return this.options.compilerConfig}get requestJsonData(){return this.options.requestJsonData}get dashFilePath(){return k.join(this.projectRoot,`.bridge/.dash.${this.getMode()}.json`)}async setup(e){var s,t,i,n;try{await this.projectConfig.setup()}catch(a){this.console.error("Failed to load project config: "+a)}(s=this.fileType)==null||s.setProjectConfig(this.projectConfig),(t=this.packType)==null||t.setProjectConfig(this.projectConfig),await((i=this.fileType)==null?void 0:i.setup(e)),await((n=this.packType)==null?void 0:n.setup(e)),await this.plugins.loadPlugins(this.options.pluginEnvironment)}async reload(){try{await this.projectConfig.refreshConfig()}catch{}await this.plugins.loadPlugins(this.options.pluginEnvironment)}get isCompilerActivated(){const e=this.projectConfig.get();return e.compiler!==void 0&&Array.isArray(e.compiler.plugins)}async build(){if(this.console.log("Starting compilation..."),!this.isCompilerActivated)return;this.jsRuntime.clearCache(),this.buildType="fullBuild",this.includedFiles.removeAll();const e=Date.now();this.progress.setTotal(7),await this.plugins.runBuildStartHooks(),this.progress.advance(),await this.includedFiles.loadAll(),this.progress.advance(),await this.compileIncludedFiles(),await this.plugins.runBuildEndHooks(),this.progress.advance(),this.getMode()==="development"&&await this.saveDashFile(),this.includedFiles.resetAll(),this.progress.advance(),this.console.log(`Dash compiled ${this.includedFiles.all().length} files in ${Date.now()-e}ms!`)}async updateFiles(e,s=!0){var c;if(!this.isCompilerActivated||e.length===0)return;this.buildType="hotUpdate",this.jsRuntime.clearCache(),this.progress.setTotal(8),this.console.log(`Dash is starting to update ${e.length} files...`),await this.includedFiles.load(this.dashFilePath),await this.plugins.runBuildStartHooks();const t=[];for(const l of e){let u=this.includedFiles.get(l);u||([u]=this.includedFiles.add([l])),t.push(u)}this.progress.advance();const i=[];for(const l of t)i.push(new Set([...l.requiredFiles]));this.progress.advance(),await this.loadFiles.run(t),this.progress.advance();for(let l=0;l<t.length;l++){const u=t[l];[...u.requiredFiles].filter(o=>!i[l].has(o)).forEach(o=>this.includedFiles.query(o).forEach(f=>f.addUpdateFile(u))),[...i[l]].filter(o=>!u.requiredFiles.has(o)).forEach(o=>this.includedFiles.query(o).forEach(f=>f.removeUpdateFile(u)))}this.progress.advance();const n=new Set(t.map(l=>[...l.filesToLoadForHotUpdate()]).flat());this.console.log(`Dash is loading ${n.size} files...`),await this.loadFiles.run([...n.values()].filter(l=>!t.includes(l))),this.progress.advance();const a=new Set(t.map(l=>[...l.getHotUpdateChain()]).flat());for(const l of n)l.isDone||(l.data=(c=await this.plugins.runTransformHooks(l))!=null?c:l.data,a.has(l)||(l.isDone=!0));this.progress.advance(),this.console.log(`Dash is compiling ${a.size} files...`),await this.fileTransformer.run(a,!0),this.progress.advance(),await this.plugins.runBuildEndHooks(),s&&await this.saveDashFile(),this.includedFiles.resetAll(),this.console.log(`Dash finished updating ${a.size} files!`),this.progress.advance()}async compileFile(e,s){var a;if(!this.isCompilerActivated)return[[],s];this.buildType="fileRequest",this.jsRuntime.clearCache(),this.progress.setTotal(7),await this.plugins.runBuildStartHooks(),await this.includedFiles.load(this.dashFilePath);let t=this.includedFiles.get(e);t||([t]=this.includedFiles.add([e])),t.setFileHandle({getFile:async()=>new File([s],k.basename(e))}),await this.loadFiles.loadFile(t,!1),await this.loadFiles.loadRequiredFiles(t),this.progress.advance();const i=t.filesToLoadForHotUpdate();await this.loadFiles.run([...i.values()].filter(c=>t!==c),!1),this.progress.advance();for(const c of i)c.isDone||(c.data=(a=await this.plugins.runTransformHooks(c))!=null?a:c.data);this.progress.advance();const n=await this.fileTransformer.transformFile(t,!0,!0);return this.progress.advance(),await this.includedFiles.load(this.dashFilePath),this.progress.advance(),await this.plugins.runBuildEndHooks(),[[...i].map(c=>c.filePath),n]}async unlinkMultiple(e){if(!(!this.isCompilerActivated||e.length===0)){for(const s of e)await this.unlink(s,!1);await this.saveDashFile()}}async unlink(e,s=!0){if(!this.isCompilerActivated)return;const t=await this.plugins.runTransformPathHooks(e);!t||t===e||(await this.outputFileSystem.unlink(t),this.includedFiles.remove(e),s&&await this.saveDashFile())}async rename(e,s){!this.isCompilerActivated||(await this.unlink(e,!1),await this.updateFiles([s],!1),await this.saveDashFile())}async getCompilerOutputPath(e){if(!this.isCompilerActivated)return;const s=await this.plugins.runTransformPathHooks(e);if(!!s)return s}async getFileDependencies(e){if(!this.isCompilerActivated)return[];await this.includedFiles.load(this.dashFilePath);const s=this.includedFiles.get(e);return s?[...s.filesToLoadForHotUpdate()].map(t=>t.isVirtual?t.outputPath:t.filePath).filter(t=>t!==null&&t!==e):[]}async saveDashFile(){await this.includedFiles.save(this.dashFilePath)}async compileIncludedFiles(e=this.includedFiles.all()){await this.loadFiles.run(e),this.progress.advance();const s=this.fileOrderResolver.run(e);this.progress.advance(),await this.fileTransformer.run(s),this.progress.advance()}async compileVirtualFiles(e){const s=this.includedFiles.add(e,!0);this.progress.addToTotal(3),s.forEach(t=>t.reset()),await this.compileIncludedFiles(s)}}class Ee{async allFiles(e){const s=[],t=await this.readdir(e);for(const{name:i,kind:n}of t)n==="directory"?s.push(...await this.allFiles(k.join(e,i))):n==="file"&&s.push(k.join(e,i));return s}async writeJson(e,s,t=!0){await this.writeFile(e,JSON.stringify(s,null,t?"	":0))}async readJson(e){const s=await this.readFile(e);try{return await A.default.parse(await s.text())}catch{throw new Error(`Invalid JSON: ${e}`)}}watchDirectory(e,s){console.warn("Watching a directory for changes is not supported on this platform!")}}Object.defineProperty(b,"initRuntimes",{enumerable:!0,get:function(){return q.initRuntimes}}),b.Command=I,b.Component=L,b.Console=K,b.Dash=Re,b.DefaultConsole=X,b.FileSystem=Ee,Object.defineProperty(b,"__esModule",{value:!0}),b[Symbol.toStringTag]="Module"});
