(function(j,O){typeof exports=="object"&&typeof module!="undefined"?O(exports,require("mc-project-core"),require("path-browserify"),require("molang"),require("bridge-common-utils"),require("json5"),require("@swc/wasm-web"),require("bridge-js-runtime"),require("is-glob")):typeof define=="function"&&define.amd?define(["exports","mc-project-core","path-browserify","molang","bridge-common-utils","json5","@swc/wasm-web","bridge-js-runtime","is-glob"],O):(j=typeof globalThis!="undefined"?globalThis:j||self,O(j.DashCompiler={},j.mcProjectCore,j.pathBrowserify,j.molang,j.bridgeCommonUtils,j.json5,j.wasmWeb,j.bridgeJsRuntime,j.isGlob))})(this,function(j,O,b,M,A,te,se,E,ie){"use strict";function W(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var T=W(te),ne=W(ie);class re extends O.ProjectConfig{constructor(e,s){super(b.dirname(s)),this.fileSystem=e,this.configPath=s}readConfig(){return this.fileSystem.readJson(this.configPath)}writeConfig(e){return this.fileSystem.writeJson(this.configPath,e)}}class J{constructor(e,s,t){this.dash=e,this.pluginId=s,this.plugin=t}async runBuildStartHook(){var e,s;try{return await((s=(e=this.plugin).buildStart)==null?void 0:s.call(e))}catch(t){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "buildStart" hook:`,t)}}async runIncludeHook(){var e,s;try{return await((s=(e=this.plugin).include)==null?void 0:s.call(e))}catch(t){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "include" hook:`,t)}}async runTransformPathHook(e){var s,t;try{return await((t=(s=this.plugin).transformPath)==null?void 0:t.call(s,e))}catch(i){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "transformPath" hook for "${e}":`,i)}}async runReadHook(e,s){var t,i;try{return await((i=(t=this.plugin).read)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "read" hook for "${e}":`,n)}}async runLoadHook(e,s){var t,i;try{return await((i=(t=this.plugin).load)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "load" hook for "${e}":`,n)}}async runRegisterAliasesHook(e,s){var t,i;try{return await((i=(t=this.plugin).registerAliases)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "registerAliases" hook for "${e}":`,n)}}async runRequireHook(e,s){var t,i;try{return await((i=(t=this.plugin).require)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "require" hook for "${e}":`,n)}}async runTransformHook(e,s,t){var i,n;try{return await((n=(i=this.plugin).transform)==null?void 0:n.call(i,e,s,t))}catch(r){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "transform" hook for "${e}":`,r)}}async runFinalizeBuildHook(e,s){var t,i;try{return await((i=(t=this.plugin).finalizeBuild)==null?void 0:i.call(t,e,s))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "finalizeBuild" hook for "${e}":`,n)}}async runBuildEndHook(){var e,s;try{return await((s=(e=this.plugin).buildEnd)==null?void 0:s.call(e))}catch(t){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "buildEnd" hook:`,t)}}async runBeforeFileUnlinked(e){var s,t;try{return await((t=(s=this.plugin).beforeFileUnlinked)==null?void 0:t.call(s,e))}catch(i){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "beforeFileUnlinked" hook for "${e}":`,i)}}}const ae=({options:a,outputFileSystem:e,hasComMojangDirectory:s,projectConfig:t,projectRoot:i,packType:n})=>{var l;a.buildName||(a.buildName=a.mode==="development"?"dev":"dist"),a.packName||(a.packName="Bridge"),(l=a.rewriteToComMojang)==null||l||(s=!1);const r={behaviorPack:"development_behavior_packs",resourcePack:"development_resource_packs",skinPack:"skin_packs",worldTemplate:"minecraftWorlds"},o=f=>s&&a.mode==="development"?`${r[f]}`:`${i}/builds/${a.buildName}`,c=(f,h)=>`${o(f)}/${a.packName} ${h}`;return{async buildStart(){if(a.mode==="production"||a.buildType==="fullBuild")if(s)for(const f in r){const h=n.getFromId(f);!h||await e.unlink(c(f,h.defaultPackPath)).catch(()=>{})}else await e.unlink(o("BP")).catch(()=>{})},transformPath(f){var y,$;if(!f||f.includes("BP/scripts/gametests/")&&a.mode==="production")return;const h=n==null?void 0:n.get(f);if(!h)return;const u=t.getAbsolutePackRoot(h.id),m=b.relative(u,f);if(["behaviorPack","resourcePack","skinPack","worldTemplate"].includes(h.id))return b.join(c(h.id,($=(y=a.packNameSuffix)==null?void 0:y[h.id])!=null?$:h.defaultPackPath),m)}}},z=({fileType:a,projectConfig:e,requestJsonData:s,options:t,console:i,jsRuntime:n})=>{const r=(u,m)=>e.resolvePackPath(u,m),o=new M.CustomMoLang({}),c=u=>u==null?void 0:u.endsWith(".molang"),l=u=>u==null?void 0:u.startsWith(e.resolvePackPath("behaviorPack","scripts/molang/")),f=u=>{var m;return(m=Object.entries(t.include).find(([y])=>(a==null?void 0:a.getId(u))===y))==null?void 0:m[1]};let h=[];return{async buildStart(){t.include=Object.assign(await s("data/packages/minecraftBedrock/location/validMoLang.json"),t.include)},transformPath(u){if(c(u)||l(u))return null},async read(u,m){if((c(u)||l(u))&&m){const y=await m.getFile();return await(y==null?void 0:y.text())}else if(f(u)&&u.endsWith(".json")&&m){const y=await m.getFile();if(!y)return;try{return T.default.parse(await y.text())}catch($){return t.buildType!=="fileRequest"&&i.error(`Error within file "${u}": ${$}`),{__error__:`Failed to load original file: ${$}`}}}},async load(u,m){if(c(u)&&m)o.parse(m);else if(l(u)){const y=await n.run(u,{console:i},m).catch($=>(i.error(`Failed to execute Molang AST script "${u}": ${$}`),null));if(!y)return null;typeof y.__default__=="function"&&h.push(y.__default__)}},async require(u){if(f(u))return[r("behaviorPack","scripts/molang/**/*.[jt]s"),r("behaviorPack","molang/**/*.molang"),r("resourcePack","molang/**/*.molang")]},async transform(u,m){const y=f(u);y&&y.length>0&&y.forEach($=>A.setObjectAt($,m,d=>{if(typeof d!="string"||d[0]==="/"||d[0]==="@")return d;if(h.length>0){let w=null;try{w=o.parse(d)}catch(k){t.buildType!=="fileRequest"&&i.error(`Error within file "${u}"; script "${d}": ${k}`)}if(w){for(const k of h)w=w.walk(k);d=w.toString()}}try{return o.transform(d)}catch(w){return t.buildType!=="fileRequest"&&i.error(`Error within file "${u}"; script "${d}": ${w}`),d}}))},finalizeBuild(u,m){if(f(u)&&typeof m!="string")return JSON.stringify(m,null,"	")},buildEnd(){h=[]}}},oe=({fileType:a})=>({registerAliases(e,s){var t,i,n,r;if((a==null?void 0:a.getId(e))==="entity"&&((i=(t=s==null?void 0:s["minecraft:entity"])==null?void 0:t.description)==null?void 0:i.identifier))return[(r=(n=s==null?void 0:s["minecraft:entity"])==null?void 0:n.description)==null?void 0:r.identifier]}});function ce(a,e){const s=V(a),t=V(e),i=s.pop(),n=t.pop(),r=L(s,t);return r!==0?r:i&&n?L(i.split("."),n.split(".")):i||n?i?-1:1:0}const le=(a,e,s)=>{fe(s);const t=ce(a,e);return G[s].includes(t)},ue=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,V=a=>{if(typeof a!="string")throw new TypeError("Invalid argument expected string");const e=a.match(ue);if(!e)throw new Error(`Invalid argument not valid semver ('${a}' received)`);return e.shift(),e},B=a=>a==="*"||a==="x"||a==="X",U=a=>{const e=parseInt(a,10);return isNaN(e)?a:e},de=(a,e)=>typeof a!=typeof e?[String(a),String(e)]:[a,e],he=(a,e)=>{if(B(a)||B(e))return 0;const[s,t]=de(U(a),U(e));return s>t?1:s<t?-1:0},L=(a,e)=>{for(let s=0;s<Math.max(a.length,e.length);s++){const t=he(a[s]||0,e[s]||0);if(t!==0)return t}return 0},G={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]},K=Object.keys(G),fe=a=>{if(typeof a!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof a}`);if(K.indexOf(a)===-1)throw new Error(`Invalid operator, expected one of ${K.join("|")}`)},me=(a,e)=>({register:s=>{var t;((t=s.type)!=null?t:"entity")===e&&(a.component=({name:i,schema:n,template:r})=>{const o=new s;i(s.component_name),n(R(Object.values(o.onPropose())[0])),r((c,{create:l})=>{l(o.onApply(c,"components")[`minecraft:${e}`])})})}});function R(a){const e={},s=Object.keys(a);if(s.length===1&&s[0].startsWith("$dynamic.list."))return{type:"array",items:R(Object.values(a)[0])};for(const[t,i]of Object.entries(a))t.startsWith("$")||(typeof i=="string"?e[t]=pe(i):Array.isArray(i)?e[t]={enum:i}:i==="object"&&(e[t]=R(i)));return{type:"object",properties:e}}function pe(a){switch(a){case"$general.boolean":return{type:"boolean"};case"$general.number":return{type:"integer"};case"$general.decimal":return{type:"number"};default:return{type:["number","integer","string","boolean","object","array"]}}}class X{constructor(e,s,t,i,n,r){this.console=e,this.fileType=s,this.componentSrc=t,this.mode=i,this.v1Compat=n,this.targetVersion=r,this.animations=[],this.animationControllers=[],this.createOnPlayer=[],this.dialogueScenes={},this.serverFiles=[],this.clientFiles={},this.lifecycleHookCount={activated:0,deactivated:0}}setProjectConfig(e){this.projectConfig=e}get name(){return this._name}async load(e,s,t){let i={component:null};const n=await e.run(s,{defineComponent:l=>l,console:this.console,Bridge:this.v1Compat?me(i,this.fileType):void 0}).catch(()=>(this.console.error(`Failed to execute component ${s}`),null));if(!n)return!1;if(typeof n.__default__!="function")if(i.component)n.__default__=i.component;else return this.console.error(`Component ${s} is not a valid component. Expected a function as the default export.`),!1;const r=l=>this._name=l;let o=l=>this.schema=l,c=()=>{};return(!t||t==="server")&&(o=()=>{},c=l=>{this.template=(f,h)=>{try{l(f,h)}catch(u){this.console.log(l.toString()),this.console.error(u)}}}),await n.__default__({name:r,schema:o,template:c}),!0}reset(){this.animations=[],this.animationControllers=[],this.clientFiles={},this.serverFiles=[]}getSchema(){return this.schema}toString(){return this.componentSrc}create(e,s,t=`minecraft:${this.fileType}`,i){var c;const n=t.split("/"),r=n.pop(),o=this.getObjAtLocation(e,[...n]);o[r]=(i?(l,f)=>i(A.deepMerge,l,f):A.deepMerge)((c=o[r])!=null?c:{},s!=null?s:{})}getObjAtLocation(e,s){let t=e;for(;s.length>0;){const i=s.shift();t[i]===void 0?t[Number(i)]!==void 0?t=t[Number(i)]:(t[i]={},t=t[i]):t=t[i]}return t}async processTemplates(e,s,t){var d,w,k,S,g,F;if(typeof this.template!="function")return;const i=(k=(w=(d=e[`minecraft:${this.fileType}`])==null?void 0:d.description)==null?void 0:w.identifier)!=null?k:"bridge:no_identifier",n=await A.hashString(`${this.name}/${i}`),r=(F=(g=(S=this.projectConfig)==null?void 0:S.get())==null?void 0:g.namespace)!=null?F:"bridge",o=(p,v)=>(this.animations.push([p,v]),this.getShortAnimName("a",n,this.animations.length-1)),c=(p,v)=>(this.animationControllers.push([p,v]),this.getShortAnimName("ac",n,this.animationControllers.length-1)),l=p=>{const v=`loot_tables/bridge/${this.getShortAnimName("lt",n,this.serverFiles.length)}.json`;return this.serverFiles.push([v,p]),v},f=p=>{const v=`trading/bridge/${this.getShortAnimName("tt",n,this.serverFiles.length)}.json`;return this.serverFiles.push([v,p]),v},h=p=>{this.serverFiles.push([`recipes/bridge/${this.getShortAnimName("recipe",n,this.serverFiles.length)}.json`,p])},u=p=>{this.serverFiles.push([`spawn_rules/bridge/${this.getShortAnimName("sr",n,this.serverFiles.length)}.json`,p])},m=(await A.hashString(`${this.name}/${t}`)).slice(0,16),y=p=>this.registerLifecycleHook(e,t,p,m,"activated"),$=p=>this.registerLifecycleHook(e,t,p,m,"deactivated");this.fileType==="entity"?this.template(s!=null?s:{},{mode:this.mode,compilerMode:this.mode,sourceEntity:()=>JSON.parse(JSON.stringify(e)),create:(p,v,_)=>this.create(e,p,v,_),location:t,identifier:i,projectNamespace:r,animationController:c,animation:o,lootTable:l,tradeTable:f,spawnRule:u,dialogueScene:!this.targetVersion||le(this.targetVersion,"1.17.10",">=")?(p,v=!0)=>{this.dialogueScenes[n]||(this.dialogueScenes[n]=[]),this.dialogueScenes[n].push(p),p.scene_tag&&v&&y({run_command:{command:[`/dialogue open @s @p ${p.scene_tag}`]}})}:void 0,onActivated:y,onDeactivated:$,client:{create:(p,v="1.10.0")=>{this.clientFiles[`entity/bridge/${n}.json`]={format_version:v,"minecraft:client_entity":Object.assign({description:{identifier:i}},p)}}}}):this.fileType==="item"?this.template(s!=null?s:{},{mode:this.mode,compilerMode:this.mode,sourceItem:()=>JSON.parse(JSON.stringify(e)),create:(p,v,_)=>this.create(e,p,v,_),location:t,identifier:i,projectNamespace:r,lootTable:l,recipe:h,player:{animationController:c,animation:o,create:(p,v,_)=>this.createOnPlayer.push([v!=null?v:"minecraft:entity",p,_])}}):this.fileType==="block"&&this.template(s!=null?s:{},{mode:this.mode,compilerMode:this.mode,sourceBlock:()=>JSON.parse(JSON.stringify(e)),create:(p,v,_)=>this.create(e,p,v,_),lootTable:l,recipe:h,location:t,identifier:i,projectNamespace:r})}async processAdditionalFiles(e,s){var l,f,h,u,m,y;const t=(f=(l=this.projectConfig)==null?void 0:l.getRelativePackRoot("behaviorPack"))!=null?f:"BP",i=(h=this.projectConfig)==null?void 0:h.getRelativePackRoot("resourcePack"),n=(y=(m=(u=s[`minecraft:${this.fileType}`])==null?void 0:u.description)==null?void 0:m.identifier)!=null?y:"bridge:no_identifier",r=await A.hashString(`${this.name}/${n}`),o=`${t}/animations/bridge/${r}.json`,c=`${t}/animation_controllers/bridge/${r}.json`;return n==="minecraft:player"&&this.createOnPlayer.forEach(([$,d,w])=>{this.create(s,d,$,w)}),i||(this.clientFiles={},this.console.error(`[${this.name}] Dash was unable to load the root of your resource pack and therefore cannot generate client files for this component.`)),{[o]:{baseFile:e,fileContent:this.createAnimations(r,s)},[c]:{baseFile:e,fileContent:this.createAnimationControllers(r,s)},[b.join(t,`dialogue/bridge/${r}.json`)]:this.dialogueScenes[r]&&this.dialogueScenes[r].length>0?{baseFile:e,fileContent:JSON.stringify({format_version:this.targetVersion,"minecraft:npc_dialogue":{scenes:this.dialogueScenes[r]}},null,"	")}:void 0,...Object.fromEntries(this.serverFiles.map(([$,d])=>[b.join(t,$),{baseFile:e,fileContent:JSON.stringify(d,null,"	")}])),...Object.fromEntries(Object.entries(this.clientFiles).map(([$,d])=>[b.join(i,$),{baseFile:e,fileContent:JSON.stringify(d,null,"	")}]))}}createAnimations(e,s){if(this.animations.length===0)return;let t=0;const i={format_version:"1.10.0",animations:{}};for(const[n,r]of this.animations){if(!n){t++;continue}const o=this.getAnimName("animation",e,t),c=this.getShortAnimName("a",e,t);i.animations[o]=n,this.create(s,{animations:{[c]:o}},"minecraft:entity/description"),r!==!1&&this.create(s,{scripts:{animate:[r?{[c]:r}:c]}},"minecraft:entity/description"),t++}return JSON.stringify(i,null,"	")}createAnimationControllers(e,s){if(this.animationControllers.length===0)return;let t=0;const i={format_version:"1.10.0",animation_controllers:{}};for(const[n,r]of this.animationControllers){if(!n){t++;continue}const o=this.getAnimName("controller.animation",e,t),c=this.getShortAnimName("ac",e,t);i.animation_controllers[o]=n,this.create(s,{animations:{[c]:o}},"minecraft:entity/description"),r!==!1&&this.create(s,{scripts:{animate:[r?{[c]:r}:c]}},"minecraft:entity/description"),t++}return JSON.stringify(i,null,"	")}getAnimName(e,s,t){return`${e}.${s}_${t}`}getShortAnimName(e,s,t){var i;return`${(i=s.slice(0,16))!=null?i:"bridge_auto"}_${e}_${t}`}registerLifecycleHook(e,s,t,i,n){e[`minecraft:${this.fileType}`].events||(e[`minecraft:${this.fileType}`].events={});const r=e[`minecraft:${this.fileType}`].events;if(n==="activated"&&s===`minecraft:${this.fileType}/components`)r["minecraft:entity_spawned"]||(r["minecraft:entity_spawned"]={}),this.addEventReponse(r["minecraft:entity_spawned"],t);else if(this.fileType==="entity"&&s.startsWith(`minecraft:${this.fileType}/component_groups/`)){const o=s.split("/").pop();this.findComponentGroupReferences(r,n==="activated"?"add":"remove",o).forEach(l=>this.addEventReponse(l,t))}else if(s.startsWith(`minecraft:${this.fileType}/permutations/`)){const o=s.split("/");if(o.pop()!=="components")throw new Error("Invalid component location inside of permutation");const c=this.getObjAtLocation(e,[...o]),l=`bridge:${i}_${n}_${n==="activated"?this.lifecycleHookCount.activated++:this.lifecycleHookCount.deactivated++}`;c.condition&&this.animationControllers.push([{states:{default:{on_entry:[`@s ${l}`]}}},n==="activated"?c.condition:`!(${c.condition})`]),r[l]=t}}addEventReponse(e,s){if(Array.isArray(e.sequence))e.sequence.push(s);else if(Object.keys(e).length===0)Object.assign(e,s);else{let t=Object.assign({},e,{filters:void 0});for(const i in e)i!=="filters"&&(e[i]=void 0);e.sequence=[t,s]}}findComponentGroupReferences(e,s,t){var n,r;let i=[];for(const o in e){const c=e[o];Array.isArray(c.sequence)?i.push(...this.findComponentGroupReferences(c.sequence,s,t)):Array.isArray(c.randomize)?i.push(...this.findComponentGroupReferences(c.randomize,s,t)):((r=(n=c[s])==null?void 0:n.component_groups)!=null?r:[]).includes(t)&&i.push(c)}return i}}function ge(a){const e=[];for(const[s,t]of a)e.push(...we(t,s));return e}function we(a,e){const s=[];for(const t in a)t.startsWith("minecraft:")||t.startsWith("tag:")||s.push([t,e]);return s}function x({fileType:a,getComponentObjects:e}){const s=new Map;let t={};return({console:i,projectConfig:n,projectRoot:r,compileFiles:o,getAliases:c,options:l,jsRuntime:f,targetVersion:h,fileType:u})=>{const m=(d,w)=>d&&a==="item"&&(u==null?void 0:u.getId(d))==="entity"&&w(d).includes("minecraft:player"),y=d=>l.v1CompatMode?d==null?void 0:d.includes("/components/"):d&&(u==null?void 0:u.getId(d))==="customComponent"&&d.includes(`/${a}/`),$=d=>d&&(u==null?void 0:u.getId(d))===a;return{buildStart(){s.clear(),t={}},transformPath(d){if(y(d)&&l.buildType!=="fileRequest")return null},async read(d,w){if(!w)return t[d]?T.default.parse(t[d].fileContent):void 0;if(y(d)&&d.endsWith(".js")){const k=await w.getFile();return await(k==null?void 0:k.text())}else if($(d)||m(d,c)){const k=await w.getFile();if(!k)return;try{return T.default.parse(await k.text())}catch(S){return l.buildType!=="fileRequest"&&i.error(`Error within file "${d}": ${S}`),{__error__:`Failed to load original file: ${S}`}}}},async load(d,w){if(y(d)&&typeof w=="string"){const k=new X(i,a,w,l.mode,!!l.v1CompatMode,h);return k.setProjectConfig(n),await k.load(f,d)?k:w}},async registerAliases(d,w){if(y(d))return[`${a}Component#${w.name}`]},async require(d,w){if(m(d,c))return[`.${n.getRelativePackRoot("behaviorPack")}/components/item/**/*.[jt]s`,`.${n.getRelativePackRoot("behaviorPack")}/items/**/*.json`];if($(d)){const k=ge(e(w));return s.set(d,k),k.map(S=>`${a}Component#${S[0]}`)}else if(t[d])return[t[d].baseFile]},async transform(d,w,k={}){var S;if(m(d,c)){const g=Object.entries(k).filter(([F])=>F.startsWith("itemComponent#")).map(([F,p])=>p);for(const F of g){if(!F)return;t=A.deepMerge(t,await F.processAdditionalFiles(d,w))}}else if($(d)){const g=new Set;for(const[F,p]of(S=s.get(d))!=null?S:[]){const v=k[`${a}Component#${F}`];if(!v)continue;const _=A.get(w,p.split("/"),{}),C=_[F];delete _[F],await v.processTemplates(w,C,p),g.add(v)}for(const F of g)t=A.deepMerge(t,await F.processAdditionalFiles(d,w));for(const F of g)F.reset()}},finalizeBuild(d,w){if(y(d)&&w)return w.toString();if($(d)||t[d])return JSON.stringify(w,null,"	")},async buildEnd(){if(l.buildType==="fileRequest")return;t=Object.fromEntries(Object.entries(t).filter(([w,k])=>(k==null?void 0:k.fileContent)!==void 0).map(([w,k])=>[b.join(r,w),k]));const d=Object.keys(t);d.length>0&&await o(d),t={}}}}}const ye=x({fileType:"entity",getComponentObjects:a=>{var e,s,t,i,n,r;return[["minecraft:entity/components",(s=(e=a==null?void 0:a["minecraft:entity"])==null?void 0:e.components)!=null?s:{}],...Object.entries((i=(t=a==null?void 0:a["minecraft:entity"])==null?void 0:t.component_groups)!=null?i:{}).map(([o,c])=>[`minecraft:entity/component_groups/${o}`,c]),...((r=(n=a==null?void 0:a["minecraft:entity"])==null?void 0:n.permutations)!=null?r:[]).map((o,c)=>{var l;return[`minecraft:entity/permutations/${c}/components`,(l=o==null?void 0:o.components)!=null?l:{}]})]}}),Fe=x({fileType:"item",getComponentObjects:a=>{var e,s;return[["minecraft:item/components",(s=(e=a==null?void 0:a["minecraft:item"])==null?void 0:e.components)!=null?s:{}]]}}),ve=x({fileType:"block",getComponentObjects:a=>{var e,s,t,i;return[["minecraft:block/components",(s=(e=a==null?void 0:a["minecraft:block"])==null?void 0:e.components)!=null?s:{}],...((i=(t=a==null?void 0:a["minecraft:block"])==null?void 0:t.permutations)!=null?i:[]).map((n,r)=>{var o;return[`minecraft:block/permutations/${r}/components`,(o=n.components)!=null?o:{}]})]}});function D(a,e,s,t=0){const i=[];for(const n of a){if(!n.startsWith("/")){i.push(n);continue}const[r,...o]=A.tokenizeCommand(n.slice(1)).tokens.map(({word:l})=>l),c=e[`command#${r}`];if(r==="execute"){let l=4;if(o[l]==="detect"&&(l+=6),o[l]===void 0){i.push(n);continue}const[f,...h]=o.slice(l),u=e[`command#${f}`];if(!(u instanceof q)){i.push(n);continue}i.push(...u.process(`${f} ${h.join(" ")}`,e,t+1).map(m=>m.startsWith("/")?`/execute ${o.slice(0,l).join(" ")} ${m.slice(1)}`:m));continue}else if(!(c instanceof q)){i.push(n);continue}i.push(...c.process(n,e,t))}return i.filter(n=>s||!n.startsWith("#")).map(n=>n.trim())}const ke=a=>({register:e=>{a.command=({name:s,schema:t,template:i})=>{s(e.command_name),t([]),i(n=>new e().onApply(n))}}});class q{constructor(e,s,t,i){this.console=e,this.commandSrc=s,this.mode=t,this.v1Compat=i}get name(){var e;return(e=this._name)!=null?e:"unknown"}async load(e,s,t){const i={command:null},n=await e.run(s,{console:this.console,defineCommand:l=>l,Bridge:this.v1Compat?ke(i):void 0}).catch(l=>(this.console.error(`Failed to execute command ${this.name}: ${l}`),null));if(!n)return null;if(typeof n.__default__!="function")if(i.command)n.__default__=i.command;else return this.console.error(`Component ${s} is not a valid component. Expected a function as the default export.`),!1;const r=l=>this._name=l;let o=l=>this.schema=l,c=()=>{};(!t||t==="server")&&(o=()=>{},c=l=>{this.template=(f,h)=>{try{return l(f,h)}catch(u){return this.console.error(u),[]}}}),await n.__default__({name:r,schema:o,template:c})}process(e,s,t){var c;e.startsWith("/")&&(e=e.slice(1));const[i,...n]=A.tokenizeCommand(e).tokens.map(({word:l})=>l),r=(c=this.template)==null?void 0:c.call(this,n.map(l=>A.castType(l)),{compilerMode:this.mode,commandNestingDepth:t,compileCommands:l=>D(l.map(f=>f.startsWith("/")?f:`/${f}`),s,!1,t+1).map(f=>f.startsWith("/")?f.slice(1):f)});let o=[];if(typeof r=="string")o=r.split(`
`);else if(Array.isArray(r))o=r.filter(l=>typeof l=="string");else{const l=`Failed to process command ${this._name}; Invalid command template return type: Expected string[] or string, received ${typeof r}`;this.console.error(l),o.push(`# ${l}`)}return o.map(l=>l.startsWith("/")||l.startsWith("#")?l:`/${l}`)}getSchema(){if(this.schema){if(Array.isArray(this.schema))return this.schema.length===0?[{commandName:this.name}]:this.schema.map(e=>({commandName:this.name,...e}))}else return[{commandName:this.name}];return this.schema.commandName||(this.schema.commandName=this.name),[this.schema]}toString(){return this.commandSrc}}const $e=({projectConfig:a,jsRuntime:e,console:s,fileType:t,requestJsonData:i,options:n})=>{const r=(h,u)=>a.resolvePackPath(h,u),o=h=>h&&t.getId(h)==="customCommand",c=h=>h&&t.getId(h)==="function",l=h=>{var u;return(u=Object.entries(n.include).find(([m])=>t.getId(h)===m))==null?void 0:u[1]},f=h=>{var u,m,y;return(y=(m=(u=t.get(h))==null?void 0:u.meta)==null?void 0:m.commandsUseSlash)!=null?y:!1};return{async buildStart(){n.include=Object.assign(await i("data/packages/minecraftBedrock/location/validCommand.json"),n.include)},transformPath(h){if(o(h)&&n.buildType!=="fileRequest")return null},async read(h,u){if(!!u){if(o(h)&&h.endsWith(".js")){const m=await u.getFile();return await(m==null?void 0:m.text())}else if(c(h)){const m=await u.getFile();return await(m==null?void 0:m.text())}else if(l(h)&&u){const m=await u.getFile();if(!m)return;try{return T.default.parse(await m.text())}catch(y){s.error(y)}}}},async load(h,u){var m;if(o(h)){const y=new q(s,u,n.mode,(m=n.v1CompatMode)!=null?m:!1);return await y.load(e,h),y}},async registerAliases(h,u){if(o(h))return[`command#${u.name}`]},async require(h){if(l(h)||c(h))return[r("behaviorPack","commands/**/*.[jt]s"),r("behaviorPack","commands/*.[jt]s")]},async transform(h,u,m={}){const y=l(h);if(y&&y.length>0){const $=f(h);y.forEach(d=>A.setObjectAt(d,u,w=>{if(!w)return w;w=Array.isArray(w)?w:[w];const k=[];for(const S of w){if(typeof S=="string"){k.push(S);continue}s.error(`The file "${h}" contains invalid commands. Expected type "string" within array but got type "${typeof S}"`)}return D(k.map(S=>!$&&!S.startsWith("/")?`/${S}`:S),m,!1).map(S=>$?S:S.slice(1))}))}else if(c(h)){const $=u.split(`
`).map(d=>d.trim()).filter(d=>d!==""&&!d.startsWith("#")).map(d=>`/${d}`);return D($,m,!0).map(d=>d.startsWith("/")?d.slice(1):d).join(`
`)}},finalizeBuild(h,u){if(o(h)&&u)return u.toString();if(l(h)&&typeof u!="string")return JSON.stringify(u,null,"	")}}},be=({options:a})=>({async transformPath(e){if(!!(e!=null&&e.endsWith(".ts")))return`${e.slice(0,-3)}.js`},async read(e,s){if(!e.endsWith(".ts")||!s)return;const t=await s.getFile();return await(t==null?void 0:t.text())},async load(e,s){if(!!e.endsWith(".ts"))return await E.loadedWasm,se.transformSync(s,{filename:b.basename(e),sourceMaps:a!=null&&a.inlineSourceMap?"inline":void 0,jsc:{parser:{syntax:"typescript",preserveAllComments:!1,topLevelAwait:!0},target:"es2020"}}).code},finalizeBuild(e,s){if(e.endsWith(".ts")&&typeof s=="string")return s}}),Se=({options:a,outputFileSystem:e,projectRoot:s,packType:t,fileType:i,console:n})=>{a.packName||(a.packName="bridge project");const r=f=>f.split(/\\|\//g).filter(h=>h!==".."&&h!==".").slice(1).join("/"),o=f=>{const h=t.getId(f),u=b.relative(s,f);if(h==="behaviorPack"||h==="resourcePack"||h==="skinPack")return b.join(s,"builds/dist",h,r(u))},c=f=>{const h=t.getId(f),u=b.relative(s,f);if(h==="worldTemplate")return b.join(s,"builds/dist",r(u));if(h==="behaviorPack"||h==="resourcePack")return b.join(s,"builds/dist",h==="behaviorPack"?"behavior_packs":"resource_packs",a.packName,r(u))},l=f=>i.getId(f)==="worldManifest"?null:c(f);return{async buildStart(){await e.unlink(`${s}/builds/dist`).catch(()=>{})},transformPath(f){if(!!f)switch(a.format){case"mcaddon":return o(f);case"mcworld":return l(f);case"mctemplate":return c(f);default:n.error(`Unknown packaging format: ${a.format}`)}}}},je=({projectConfig:a,packType:e,options:s})=>{const t=Object.keys(a.getAvailablePacks()),i=Object.fromEntries(t.map(r=>[r,[]])),n=r=>{const o=e.getId(r);if(o!=="unknown")return[o,a.resolvePackPath(o,"contents.json")]};return s.buildType!=="fullBuild"?{}:{include(){return t.map(r=>[a.resolvePackPath(r,"contents.json"),{isVirtual:!0}])},read(r){const o=n(r);if(!o)return;const[c,l]=o;if(r!==l)return i[c]},transformPath(r){if(!r)return;const o=e.getId(r);o!=="unknown"&&i[o].push(r)},finalizeBuild(r){const o=n(r);if(!o)return;const[c,l]=o;if(r!==l)return JSON.stringify(i[c])}}},_e=({fileType:a})=>{const e=[];for(const t of a.all)t.formatVersionMap&&e.push(t.id);const s=t=>t&&e.includes(a.getId(t));return{async read(t,i){if(!!i&&s(t)){const n=await i.getFile();if(!n)return;try{return T.default.parse(await n.text())}catch(r){console.error(r)}}},load(t,i){if(s(t))return i},transform(t,i){if(s(t)){const n=a.get(t),r=n==null?void 0:n.formatVersionMap;if(!r)return;const o=i==null?void 0:i.format_version;return o&&r[o]&&(i.format_version=r[o]),i}},finalizeBuild(t,i){if(s(t))return JSON.stringify(i)}}};class N{constructor(e,s){this.console=e,this.baseDir=s,this.files=new Map}get hasFiles(){return this.files.size>0}getAll(){return[...this.files.entries()]}get(e){return this.files.get(e)}clear(){this.files.clear()}add(e,s){const t=this.baseDir?b.join(this.baseDir,e):e;if(this.files.has(t)){this.console.warn(`Omitting file "${t}" from collection because it would overwrite a previously generated file!`);return}this.files.set(t,s)}has(e){return this.files.has(e)}addFrom(e){for(const[s,t]of e.getAll())this.add(s,t)}}function Ae({generatorPath:a,omitUsedTemplates:e,fileSystem:s,console:t}){return{useTemplate:(i,{omitTemplate:n=!0}={})=>{const r=b.join(b.dirname(a),i);return n&&e.add(r),i.endsWith(".json")?s.readJson(r):s.readFile(r).then(o=>o.text())},createCollection:()=>new N(t,b.dirname(a))}}const Ce=({options:a,fileType:e,console:s,jsRuntime:t,fileSystem:i,compileFiles:n,getFileMetadata:r,unlinkOutputFiles:o,addFileDependencies:c})=>{var S;const l=new Set(["gameTest","customCommand","customComponent","molangAstScript",...(S=a.ignoredFileTypes)!=null?S:[]]),f=g=>e.getId(g),h=g=>{var p;const F=e.get(g,void 0,!1);return F?(p=F.type)!=null?p:"json":"raw"},u=g=>!l.has(f(g))&&(g.endsWith(".js")||g.endsWith(".ts")),m=g=>{var p,v,_,C;return h(g)==="json"?".json":(C=(_=(v=(p=e.get(g))==null?void 0:p.detect)==null?void 0:v.fileExtensions)==null?void 0:_[0])!=null?C:".txt"},y=g=>g.replace(/\.(js|ts)$/,m(g)),$=new Set,d=new N(s),w=new Set,k=new Map;return{buildStart(){d.clear(),$.clear(),w.clear(),k.clear()},transformPath(g){if(g&&u(g))return y(g)},async read(g,F){if(u(g)&&F){const v=await F.getFile();return v?v.text():void 0}const p=d.get(g);if(p)return p},async load(g,F){var v,_;const p=new Set;if(t.registerModule("@bridge/generate",Ae({generatorPath:g,fileSystem:i,omitUsedTemplates:p,console:s})),u(g)){if(!F)return null;const C=await t.run(g,{console:s},F).catch(I=>(s.error(`Failed to execute generator script "${g}": ${I}`),null));if(!C)return null;if(!C.__default__)return s.error(`Expected generator script "${g}" to provide file content as default export!`),null;const P=r(g);((v=P.get("unlinkedFiles"))!=null?v:[]).filter(I=>!p.has(I)).forEach(I=>w.add(I)),P.set("unlinkedFiles",[...p]);const Ne=(_=P.get("generatedFiles"))!=null?_:[];return await o([...Ne,...p]).catch(()=>{}),k.set(g,p),C.__default__}},require(g){const F=k.get(g);if(F)return[...F]},finalizeBuild(g,F){if(d.get(g))return g.endsWith(".json")&&typeof F!="string"?JSON.stringify(F,null,"	"):F;if($.has(g))return null;if(u(g)){if(F===null)return null;const p=r(g);return F instanceof N?(d.addFrom(F),p.set("generatedFiles",F.getAll().map(([v])=>v)),null):(p.set("generatedFiles",[y(g)]),typeof F=="object"?JSON.stringify(F):F)}},async buildEnd(){t.deleteModule("@bridge/generate"),w.size>0&&await n([...w].filter(g=>!d.has(g)),!1),d.hasFiles&&await n(d.getAll().map(([g])=>g))},async beforeFileUnlinked(g){var F,p;if(u(g)){const v=r(g),_=(F=v.get("unlinkedFiles"))!=null?F:[],C=(p=v.get("generatedFiles"))!=null?p:[];await o(C),await n(_)}}}};class Q extends E.Runtime{constructor(e,s){super(s),this.fs=e}readFile(e){return this.fs.readFile(e).then(s=>s.text())}deleteModule(e){this.baseModules.delete(e)}}const Y={simpleRewrite:ae,rewriteForPackaging:Se,moLang:z,molang:z,entityIdentifierAlias:oe,customEntityComponents:ye,customItemComponents:Fe,customBlockComponents:ve,customCommands:$e,typeScript:be,contentsFile:je,formatVersionCorrection:_e,generatorScripts:Ce};class Te{constructor(e){this.dash=e,this.plugins=[],this.pluginRuntime=new Q(this.dash.fileSystem)}async loadPlugins(e={}){var n,r;this.plugins=[],this.pluginRuntime.clearCache();const s=[...(await this.dash.fileSystem.readdir(b.join(this.dash.projectRoot,".bridge/extensions")).catch(()=>[])).map(o=>o.kind==="directory"?b.join(this.dash.projectRoot,".bridge/extensions",o.name):void 0),...(await this.dash.fileSystem.readdir("extensions").catch(()=>[])).map(o=>o.kind==="directory"?b.join("extensions",o.name):void 0)],t={};for(const o of s){if(!o)continue;let c;try{c=await this.dash.fileSystem.readJson(b.join(o,"manifest.json"))}catch{continue}if(!!((n=c==null?void 0:c.compiler)!=null&&n.plugins))for(const l in c.compiler.plugins)t[l]=b.join(o,c.compiler.plugins[l])}const i=(r=(await this.getCompilerOptions()).plugins)!=null?r:[];for(const o of i){const c=typeof o=="string"?o:o[0],l=typeof o=="string"?{}:o[1];if(t[c]){const f=await this.pluginRuntime.run(t[c],{console:this.dash.console,...e}).catch(h=>(this.dash.console.error(`Failed to execute plugin ${c}: ${h}`),null));if(!f)continue;typeof f.__default__=="function"?this.plugins.push(new J(this.dash,c,f.__default__(await this.getPluginContext(c,l)))):this.dash.console.error(`Plugin ${c} is invalid: It does not provide a function as a default export.`)}else Y[c]?this.plugins.push(new J(this.dash,c,Y[c](await this.getPluginContext(c,l)))):this.dash.console.error(`Unknown compiler plugin: ${c}`)}}async getCompilerOptions(){var s;const e=await this.dash.getCompilerConfigPath();return e?await this.dash.fileSystem.readJson(e):(s=this.dash.projectConfig.get().compiler)!=null?s:{}}async getPluginContext(e,s={}){const t=this.dash;return{options:{get mode(){return t.getMode()},get buildType(){return t.buildType},...s},jsRuntime:this.dash.jsRuntime,console:this.dash.console,fileSystem:this.dash.fileSystem,outputFileSystem:this.dash.outputFileSystem,projectConfig:this.dash.projectConfig,projectRoot:this.dash.projectRoot,packType:this.dash.packType,fileType:this.dash.fileType,targetVersion:this.dash.projectConfig.get().targetVersion,requestJsonData:this.dash.requestJsonData,getAliases:i=>{var n,r;return[...(r=(n=this.dash.includedFiles.get(i))==null?void 0:n.aliases)!=null?r:[]]},getFileMetadata:i=>{const n=this.dash.includedFiles.get(i);if(!n)throw new Error(`File ${i} to add metadata to not found`);return{get(r){return n.getMetadata(r)},set(r,o){n.addMetadata(r,o)},delete(r){n.deleteMetadata(r)}}},addFileDependencies:(i,n,r=!1)=>{const o=this.dash.includedFiles.get(i);if(!o)throw new Error(`File ${i} to add dependency to not found`);r?o.setRequiredFiles(new Set(n)):n.forEach(c=>o.addRequiredFile(c))},getOutputPath:i=>this.dash.getCompilerOutputPath(i),unlinkOutputFiles:i=>this.dash.unlinkMultiple(i,!1,!0),hasComMojangDirectory:this.dash.fileSystem!==this.dash.outputFileSystem,compileFiles:(i,n=!0)=>this.dash.compileAdditionalFiles(i,n)}}async runBuildStartHooks(){for(const e of this.plugins)await e.runBuildStartHook()}async runIncludeHooks(){let e=[];for(const s of this.plugins){const t=await s.runIncludeHook();Array.isArray(t)&&e.push(...t)}return e}async runTransformPathHooks(e){let s=e;for(const t of this.plugins){const i=await t.runTransformPathHook(s);if(i===null)return null;i!==void 0&&(s=i)}return s}async runReadHooks(e,s){for(const t of this.plugins){const i=await t.runReadHook(e,s);if(i!=null)return i}}async runLoadHooks(e,s){let t=s;for(const i of this.plugins){const n=await i.runLoadHook(e,t);n!==void 0&&(t=n)}return t}async runRegisterAliasesHooks(e,s){const t=new Set;for(const i of this.plugins){const n=await i.runRegisterAliasesHook(e,s);n!=null&&(Array.isArray(n)?n.forEach(r=>t.add(r)):t.add(n))}return t}async runRequireHooks(e,s){const t=new Set;for(const i of this.plugins){const n=await i.runRequireHook(e,s);n!=null&&(Array.isArray(n)?n.forEach(r=>t.add(r)):t.add(n))}return t}async runTransformHooks(e){const s=Object.fromEntries([...e.requiredFiles].map(i=>this.dash.includedFiles.query(i)).flat().map(i=>[[i.filePath,i.data],...[...i.aliases].map(n=>[n,i.data])]).flat());let t=e.data;for(const i of this.plugins){const n=await i.runTransformHook(e.filePath,t,s);n!==void 0&&(t=n)}return t}async runFinalizeBuildHooks(e){for(const s of this.plugins){const t=await s.runFinalizeBuildHook(e.filePath,e.data);if(t!==void 0)return t}}async runBuildEndHooks(){for(const e of this.plugins)await e.runBuildEndHook()}async runBeforeFileUnlinked(e){for(const s of this.plugins)await s.runBeforeFileUnlinked(e)}}class H{constructor(e,s,t=!1){this.dash=e,this.filePath=s,this.isVirtual=t,this.isDone=!1,this.requiredFiles=new Set,this.aliases=new Set,this.updateFiles=new Set,this.metadata=new Map,this.outputPath=s,this.isVirtual||this.setDefaultFileHandle()}setFileHandle(e){this.fileHandle=e}setDefaultFileHandle(){this.setFileHandle({getFile:()=>this.dash.fileSystem.readFile(this.filePath).catch(()=>null)})}setOutputPath(e){this.outputPath=e}setReadData(e){this.data=e}setAliases(e){for(const s of e)this.dash.includedFiles.addAlias(s,this);this.aliases=e}setRequiredFiles(e){this.requiredFiles=e}addRequiredFile(e){this.requiredFiles.add(e)}setUpdateFiles(e){this.updateFiles=new Set(e.map(s=>this.dash.includedFiles.get(s)).filter(s=>s!==void 0))}addUpdateFile(e){this.updateFiles.add(e)}removeUpdateFile(e){this.updateFiles.delete(e)}setMetadata(e){typeof e=="object"&&(this.metadata=new Map(Object.entries(e)))}addMetadata(e,s){this.metadata.set(e,s)}deleteMetadata(e){this.metadata.delete(e)}getMetadata(e){return this.metadata.get(e)}getAllMetadata(){return Object.fromEntries(this.metadata.entries())}getHotUpdateChain(){const e=new Set([this]);for(const s of this.updateFiles)s.getHotUpdateChain().forEach(t=>{e.add(t)});return e}filesToLoadForHotUpdate(e=new Set,s=!0){const t=new Set;if(e.has(this))return t;e.add(this);for(const i of this.requiredFiles){const n=this.dash.includedFiles.query(i);for(const r of n)r.filesToLoadForHotUpdate(e,!1).forEach(o=>{t.add(o)})}if(t.add(this),s)for(const i of this.updateFiles)i.filesToLoadForHotUpdate(e,!0).forEach(n=>{t.add(n)});return t}async processAfterLoad(e){if((this.data===null||this.data===void 0)&&(this.isDone=!0,this.filePath!==this.outputPath&&this.outputPath!==null&&!this.isVirtual&&e)){const s=await this.dash.fileSystem.readFile(this.filePath);await this.dash.outputFileSystem.writeFile(this.outputPath,new Uint8Array(await s.arrayBuffer()))}}serialize(){return{isVirtual:this.isVirtual,filePath:this.filePath,aliases:[...this.aliases],requiredFiles:[...this.requiredFiles],updateFiles:[...this.updateFiles].map(e=>e.filePath),metadata:this.metadata.size>0?Object.fromEntries(this.metadata.entries()):void 0}}reset(){this.isDone=!1,this.data=null,this.isVirtual||this.setDefaultFileHandle()}}class Oe{constructor(e){this.dash=e,this.files=new Map,this.aliases=new Map,this.queryCache=new Map}all(){return[...this.files.values()]}filtered(e){return this.all().filter(s=>e(s))}get(e){var s;return(s=this.aliases.get(e))!=null?s:this.files.get(e)}query(e){if(ne.default(e))return this.queryGlob(e);const s=this.aliases.get(e);if(s)return[s];const t=this.files.get(e);return t?[t]:[]}addAlias(e,s){this.aliases.set(e,s)}queryGlob(e){if(this.queryCache.has(e))return this.queryCache.get(e);const s=this.filtered(t=>A.isMatch(t.filePath,e));return this.queryCache.set(e,s),s}async loadAll(){this.queryCache=new Map;const e=new Set,s=this.dash.projectConfig.getAvailablePackPaths();for(const i of s){const n=await this.dash.fileSystem.allFiles(i).catch(r=>(this.dash.console.warn(r),[]));for(const r of n)e.add(r)}const t=await this.dash.plugins.runIncludeHooks();for(const i of t)typeof i=="string"?e.add(i):this.addOne(i[0],i[1].isVirtual);this.add([...e])}addOne(e,s=!1){const t=new H(this.dash,e,s);return this.files.set(e,t),t}add(e,s=!1){let t=[];for(const i of e){const n=this.files.get(i);if(n){t.push(n);continue}t.push(new H(this.dash,i,s)),this.files.set(i,t[t.length-1])}return t}remove(e){const s=this.files.get(e);if(!!s){this.files.delete(e);for(const t of s.aliases)this.aliases.delete(t)}}async save(e){await this.dash.fileSystem.writeJson(e,this.all().map(s=>s.serialize()))}async load(e){this.removeAll();const s=await this.dash.fileSystem.readJson(e),t=[];for(const i of s){const n=new H(this.dash,i.filePath,i.isVirtual);n.setAliases(new Set(i.aliases)),n.setRequiredFiles(new Set(i.requiredFiles)),n.setMetadata(i.metadata),t.push(n);for(const r of i.aliases)this.aliases.set(r,n)}this.files=new Map(t.map(i=>[i.filePath,i]));for(let i=0;i<t.length;i++)t[i].setUpdateFiles(s[i].updateFiles)}resetAll(){for(const e of this.all())e.reset()}removeAll(){this.files=new Map,this.aliases=new Map,this.queryCache=new Map}}class Me{constructor(e){this.dash=e}async run(e,s=!0){for(const t of e)t.isDone||await this.loadFile(t,s);for(const t of e)t.isDone||await this.loadRequiredFiles(t)}async loadFile(e,s=!0){var r;const[t,i]=await Promise.all([this.dash.plugins.runTransformPathHooks(e.filePath),this.dash.plugins.runReadHooks(e.filePath,e.fileHandle)]);if(e.setOutputPath(t),e.setReadData(i),await e.processAfterLoad(s),e.isDone)return;e.setReadData((r=await this.dash.plugins.runLoadHooks(e.filePath,e.data))!=null?r:e.data);const n=await this.dash.plugins.runRegisterAliasesHooks(e.filePath,e.data);e.setAliases(n)}async loadRequiredFiles(e){const s=await this.dash.plugins.runRequireHooks(e.filePath,e.data);e.setRequiredFiles(s)}}class Ie{constructor(e){this.dash=e}run(e){const s=new Set;for(const t of e)t.isDone||s.has(t)||this.resolveSingle(t,s);return s}resolveSingle(e,s,t=new Set){const i=this.dash.includedFiles;t.add(e);for(const n of e.requiredFiles){const r=i.query(n);for(const o of r){if(!o){this.dash.console.error(`Undefined file dependency: "${e.filePath}" requires "${n}"`);continue}if(o.addUpdateFile(e),!s.has(o)){if(t.has(o)){this.dash.console.error(`Circular dependency detected: ${o.filePath} is required by ${e.filePath} but also depends on this file.`);continue}this.resolveSingle(o,s,t)}}}s.add(e),t.delete(e)}}function qe(a){return typeof a=="string"||a instanceof Blob||a instanceof File||a instanceof ArrayBuffer||(a==null?void 0:a.buffer)instanceof ArrayBuffer}class Ee{constructor(e){this.dash=e}async run(e,s=!1){for(const t of e){if(t.isDone)continue;let i=await this.transformFile(t,!0,s);i!=null&&t.outputPath&&await this.dash.outputFileSystem.writeFile(t.outputPath,i)}}async transformFile(e,s=!1,t=!1){var n;if(t||(e.data=(n=await this.dash.plugins.runTransformHooks(e))!=null?n:e.data),!s)return e.data;let i=await this.dash.plugins.runFinalizeBuildHooks(e);return i===void 0&&(i=e.data),i!=null&&(qe(i)||(this.dash.console.warn(`File "${e.filePath}" was not in a writable format: "${typeof i}". Trying to JSON.stringify(...) it...`,i),i=JSON.stringify(i))),e.isDone=!0,i}}class Re{constructor(e=1){this.total=e,this.current=0,this.onChangeCbs=new Set}get percentage(){return this.current/this.total}onChange(e){return this.onChangeCbs.add(e),{dispose:()=>this.onChangeCbs.delete(e)}}setTotal(e){this.total=e,this.current=0,this.onChangeCbs.forEach(s=>s(this))}updateCurrent(e){this.current=e,this.onChangeCbs.forEach(s=>s(this))}advance(){this.current++,this.onChangeCbs.forEach(e=>e(this))}addToTotal(e){this.total+=e,this.onChangeCbs.forEach(s=>s(this))}}class Z{constructor(){this._timers=new Map}time(e){if(this._timers.has(e)){this.warn(`Timer "${e}" already exists.`);return}else this._timers.set(e,Date.now())}timeEnd(e){const s=this._timers.get(e);if(s)this._timers.delete(e),this.log(`${e}: ${Date.now()-s}ms`);else{this.warn(`Timer "${e}" does not exist.`);return}}}class ee extends Z{log(...e){console.log(...e)}error(...e){console.error(...e)}warn(...e){console.warn(...e)}info(...e){console.info(...e)}}class xe{constructor(e,s,t){var i;this.fileSystem=e,this.options=t,this.progress=new Re,this.plugins=new Te(this),this.includedFiles=new Oe(this),this.loadFiles=new Me(this),this.fileOrderResolver=new Ie(this),this.fileTransformer=new Ee(this),this.buildType="fullBuild",this.outputFileSystem=s!=null?s:e,this.projectRoot=b.dirname(t.config),this.projectConfig=new re(e,t.config),this.console=(i=t.console)!=null?i:new ee,this.jsRuntime=new Q(this.fileSystem,[["@molang/expressions",M.expressions],["@molang/core",{MoLang:M.MoLang}],["molang",{MoLang:M.MoLang,...M.expressions}],["@bridge/compiler",{mode:t.mode}]]),this.packType=t.packType,this.fileType=t.fileType}getMode(){var e;return(e=this.options.mode)!=null?e:"development"}getCompilerConfigPath(){return this.options.compilerConfig}get requestJsonData(){return this.options.requestJsonData}get dashFilePath(){return b.join(this.projectRoot,`.bridge/.dash.${this.getMode()}.json`)}async setup(e){var s,t,i,n;try{await this.projectConfig.setup()}catch(r){this.console.error("Failed to load project config: "+r)}(s=this.fileType)==null||s.setProjectConfig(this.projectConfig),(t=this.packType)==null||t.setProjectConfig(this.projectConfig),await((i=this.fileType)==null?void 0:i.setup(e)),await((n=this.packType)==null?void 0:n.setup(e)),await this.plugins.loadPlugins(this.options.pluginEnvironment)}async reload(){try{await this.projectConfig.refreshConfig()}catch{}await this.plugins.loadPlugins(this.options.pluginEnvironment)}get isCompilerActivated(){const e=this.projectConfig.get();return e.compiler!==void 0&&Array.isArray(e.compiler.plugins)}async build(){if(this.console.log("Starting compilation..."),!this.isCompilerActivated)return;this.jsRuntime.clearCache(),this.buildType="fullBuild",this.includedFiles.removeAll();const e=Date.now();this.progress.setTotal(7),await this.plugins.runBuildStartHooks(),this.progress.advance(),await this.includedFiles.loadAll(),this.progress.advance(),await this.compileIncludedFiles(),await this.plugins.runBuildEndHooks(),this.progress.advance(),this.getMode()==="development"&&await this.saveDashFile(),this.includedFiles.resetAll(),this.progress.advance(),this.console.log(`Dash compiled ${this.includedFiles.all().length} files in ${Date.now()-e}ms!`)}async updateFiles(e,s=!0){var o;if(!this.isCompilerActivated||e.length===0)return;this.buildType="hotUpdate",this.jsRuntime.clearCache(),this.progress.setTotal(8),this.console.log(`Dash is starting to update ${e.length} files...`),await this.includedFiles.load(this.dashFilePath),await this.plugins.runBuildStartHooks();const t=[];for(const c of e){let l=this.includedFiles.get(c);l||([l]=this.includedFiles.add([c])),t.push(l)}this.progress.advance();const i=[];for(const c of t)i.push(new Set([...c.requiredFiles]));this.progress.advance(),await this.loadFiles.run(t),this.progress.advance();for(let c=0;c<t.length;c++){const l=t[c];[...l.requiredFiles].filter(u=>!i[c].has(u)).forEach(u=>this.includedFiles.query(u).forEach(m=>m.addUpdateFile(l))),[...i[c]].filter(u=>!l.requiredFiles.has(u)).forEach(u=>this.includedFiles.query(u).forEach(m=>m.removeUpdateFile(l)))}this.progress.advance();const n=new Set(t.map(c=>[...c.filesToLoadForHotUpdate()]).flat());this.console.log(`Dash is loading ${n.size} files...`),await this.loadFiles.run([...n.values()].filter(c=>!t.includes(c))),this.progress.advance();const r=new Set(t.map(c=>[...c.getHotUpdateChain()]).flat());for(const c of n)c.isDone||(c.data=(o=await this.plugins.runTransformHooks(c))!=null?o:c.data,r.has(c)||(c.isDone=!0));this.progress.advance(),this.console.log(`Dash is compiling ${r.size} files...`),await this.fileTransformer.run(r,!0),this.progress.advance(),await this.plugins.runBuildEndHooks(),s&&await this.saveDashFile(),this.includedFiles.resetAll(),this.console.log(`Dash finished updating ${r.size} files!`),this.progress.advance()}async compileFile(e,s){var r;if(!this.isCompilerActivated)return[[],s];this.buildType="fileRequest",this.jsRuntime.clearCache(),this.progress.setTotal(7),await this.plugins.runBuildStartHooks(),await this.includedFiles.load(this.dashFilePath);let t=this.includedFiles.get(e);t||([t]=this.includedFiles.add([e])),t.setFileHandle({getFile:async()=>new File([s],b.basename(e))}),await this.loadFiles.loadFile(t,!1),await this.loadFiles.loadRequiredFiles(t),this.progress.advance();const i=t.filesToLoadForHotUpdate();await this.loadFiles.run([...i.values()].filter(o=>t!==o),!1),this.progress.advance();for(const o of i)o.isDone||(o.data=(r=await this.plugins.runTransformHooks(o))!=null?r:o.data);this.progress.advance();const n=await this.fileTransformer.transformFile(t,!0,!0);return this.progress.advance(),await this.includedFiles.load(this.dashFilePath),this.progress.advance(),await this.plugins.runBuildEndHooks(),[[...i].map(o=>o.filePath),n]}async unlinkMultiple(e,s=!0,t=!1){if(!this.isCompilerActivated||e.length===0)return;const i=[];for(const n of e)await this.unlink(n,!1,t).catch(r=>i.push(r));if(i.length>0)throw i[0];s&&await this.saveDashFile()}async unlink(e,s=!0,t=!1){if(!this.isCompilerActivated)return;const i=await this.getCompilerOutputPath(e);!i||i===e||(t||(await this.plugins.runBeforeFileUnlinked(e),this.includedFiles.remove(e)),await this.outputFileSystem.unlink(i),s&&await this.saveDashFile())}async rename(e,s){!this.isCompilerActivated||(await this.unlink(e,!1),await this.updateFiles([s],!1),await this.saveDashFile())}async getCompilerOutputPath(e){var i;if(!this.isCompilerActivated)return;const s=this.includedFiles.get(e);if(s&&s.outputPath!==e)return(i=s.outputPath)!=null?i:void 0;const t=await this.plugins.runTransformPathHooks(e);if(!!t)return t}async getFileMetadata(e){if(!this.isCompilerActivated)return;const s=this.includedFiles.get(e);return s?s.getAllMetadata():null}async getFileDependencies(e){if(!this.isCompilerActivated)return[];await this.includedFiles.load(this.dashFilePath);const s=this.includedFiles.get(e);return s?[...s.filesToLoadForHotUpdate()].map(t=>t.isVirtual?t.outputPath:t.filePath).filter(t=>t!==null&&t!==e):[]}async saveDashFile(){await this.includedFiles.save(this.dashFilePath)}async compileIncludedFiles(e=this.includedFiles.all()){await this.loadFiles.run(e),this.progress.advance();const s=this.fileOrderResolver.run(e);this.progress.advance(),await this.fileTransformer.run(s),this.progress.advance()}async compileAdditionalFiles(e,s=!0){const t=this.includedFiles.add(e,s);this.progress.addToTotal(3),t.forEach(i=>i.reset()),await this.compileIncludedFiles(t)}}class De{async allFiles(e){const s=[],t=await this.readdir(e);for(const{name:i,kind:n}of t)n==="directory"?s.push(...await this.allFiles(b.join(e,i))):n==="file"&&s.push(b.join(e,i));return s}async writeJson(e,s,t=!0){await this.writeFile(e,JSON.stringify(s,null,t?"	":0))}async readJson(e){const s=await this.readFile(e);try{return await T.default.parse(await s.text())}catch{throw new Error(`Invalid JSON: ${e}`)}}watchDirectory(e,s){console.warn("Watching a directory for changes is not supported on this platform!")}}Object.defineProperty(j,"initRuntimes",{enumerable:!0,get:function(){return E.initRuntimes}}),j.Command=q,j.Component=X,j.Console=Z,j.Dash=xe,j.DefaultConsole=ee,j.FileSystem=De,Object.defineProperty(j,"__esModule",{value:!0}),j[Symbol.toStringTag]="Module"});
