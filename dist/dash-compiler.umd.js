(function(A,M){typeof exports=="object"&&typeof module!="undefined"?M(exports,require("mc-project-core"),require("path-browserify"),require("molang"),require("bridge-common-utils"),require("json5"),require("@swc/wasm-web"),require("bridge-js-runtime"),require("is-glob")):typeof define=="function"&&define.amd?define(["exports","mc-project-core","path-browserify","molang","bridge-common-utils","json5","@swc/wasm-web","bridge-js-runtime","is-glob"],M):(A=typeof globalThis!="undefined"?globalThis:A||self,M(A.DashCompiler={},A.mcProjectCore,A.pathBrowserify,A.molang,A.bridgeCommonUtils,A.json5,A.wasmWeb,A.bridgeJsRuntime,A.isGlob))})(this,function(A,M,j,O,C,se,ie,D,ne){"use strict";function B(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var T=B(se),re=B(ne);class ae extends M.ProjectConfig{constructor(e,t){super(j.dirname(t)),this.fileSystem=e,this.configPath=t}readConfig(){return this.fileSystem.readJson(this.configPath)}writeConfig(e){return this.fileSystem.writeJson(this.configPath,e)}}class oe{constructor(e,t,s){this.dash=e,this.pluginId=t,this.plugin=s}implementsHook(e){return typeof this.plugin[e]=="function"}async runBuildStartHook(){var e,t;try{return await((t=(e=this.plugin).buildStart)==null?void 0:t.call(e))}catch(s){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "buildStart" hook:`,s)}}async runIncludeHook(){var e,t;try{return await((t=(e=this.plugin).include)==null?void 0:t.call(e))}catch(s){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "include" hook:`,s)}}async runIgnoreHook(e){var t,s;try{return await((s=(t=this.plugin).ignore)==null?void 0:s.call(t,e))}catch(i){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "ignore" hook for "${e}":`,i)}}async runTransformPathHook(e){var t,s;try{return await((s=(t=this.plugin).transformPath)==null?void 0:s.call(t,e))}catch(i){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "transformPath" hook for "${e}":`,i)}}async runReadHook(e,t){var s,i;try{return await((i=(s=this.plugin).read)==null?void 0:i.call(s,e,t))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "read" hook for "${e}":`,n)}}async runLoadHook(e,t){var s,i;try{return await((i=(s=this.plugin).load)==null?void 0:i.call(s,e,t))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "load" hook for "${e}":`,n)}}async runRegisterAliasesHook(e,t){var s,i;try{return await((i=(s=this.plugin).registerAliases)==null?void 0:i.call(s,e,t))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "registerAliases" hook for "${e}":`,n)}}async runRequireHook(e,t){var s,i;try{return await((i=(s=this.plugin).require)==null?void 0:i.call(s,e,t))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "require" hook for "${e}":`,n)}}async runTransformHook(e,t,s){var i,n;try{return await((n=(i=this.plugin).transform)==null?void 0:n.call(i,e,t,s))}catch(r){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "transform" hook for "${e}":`,r)}}async runFinalizeBuildHook(e,t){var s,i;try{return await((i=(s=this.plugin).finalizeBuild)==null?void 0:i.call(s,e,t))}catch(n){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "finalizeBuild" hook for "${e}":`,n)}}async runBuildEndHook(){var e,t;try{return await((t=(e=this.plugin).buildEnd)==null?void 0:t.call(e))}catch(s){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "buildEnd" hook:`,s)}}async runBeforeFileUnlinked(e){var t,s;try{return await((s=(t=this.plugin).beforeFileUnlinked)==null?void 0:s.call(t,e))}catch(i){this.dash.console.error(`The plugin "${this.pluginId}" threw an error while running the "beforeFileUnlinked" hook for "${e}":`,i)}}}const le=({options:a,outputFileSystem:e,hasComMojangDirectory:t,projectConfig:s,projectRoot:i,packType:n})=>{var c;a.buildName||(a.buildName=a.mode==="development"?"dev":"dist"),a.packName||(a.packName="Bridge"),(c=a.rewriteToComMojang)==null||c||(t=!1);const r={behaviorPack:"development_behavior_packs",resourcePack:"development_resource_packs",skinPack:"skin_packs",worldTemplate:"minecraftWorlds"},l=m=>t&&a.mode==="development"?`${r[m]}`:`${i}/builds/${a.buildName}`,u=(m,g)=>`${l(m)}/${a.packName} ${g}`;return{async buildStart(){if(a.mode==="production"||a.buildType==="fullBuild")if(t)for(const m in r){const g=n.getFromId(m);!g||await e.unlink(u(m,g.defaultPackPath)).catch(()=>{})}else await e.unlink(l("BP")).catch(()=>{})},transformPath(m){var F,v;if(!m||m.includes("BP/scripts/gametests/")&&a.mode==="production")return;const g=n==null?void 0:n.get(m);if(!g)return;const d=s.getAbsolutePackRoot(g.id),w=j.relative(d,m);if(["behaviorPack","resourcePack","skinPack","worldTemplate"].includes(g.id))return j.join(u(g.id,(v=(F=a.packNameSuffix)==null?void 0:F[g.id])!=null?v:g.defaultPackPath),w)}}},z=async({fileType:a,projectConfig:e,requestJsonData:t,options:s,console:i,jsRuntime:n,fileSystem:r})=>{const l=(f,k)=>e.resolvePackPath(f,k),u=new O.CustomMoLang({}),c=[e.resolvePackPath("behaviorPack","molang"),e.resolvePackPath("resourcePack","molang")],m=f=>f&&c.some(k=>f.startsWith(`${k}/`))&&f.endsWith(".molang"),g=e.resolvePackPath("behaviorPack","scripts/molang"),d=f=>f==null?void 0:f.startsWith(`${g}/`),w=new Map,F=f=>{if(w.has(f))return w.get(f);const k=s.include[a.getId(f)];return w.set(f,k),k};let v=[],$=!1;return!(await Promise.all(c.map(f=>r.directoryHasAnyFile(f)))).some(f=>f)&&!await r.directoryHasAnyFile(g)?{}:{async buildStart(){s.include=Object.assign(await t("data/packages/minecraftBedrock/location/validMoLang.json"),s.include),w.clear(),$=!1},ignore(f){return!m(f)&&!d(f)&&!F(f)},transformPath(f){if(m(f)||d(f))return null},async read(f,k){if((m(f)||d(f))&&k){$=!0;const o=await k.getFile();return await(o==null?void 0:o.text())}else if(F(f)&&f.endsWith(".json")&&k){const o=await k.getFile();if(!o)return;try{return T.default.parse(await o.text())}catch(p){return s.buildType!=="fileRequest"&&i.error(`Error within file "${f}": ${p}`),{__error__:`Failed to load original file: ${p}`}}}},async load(f,k){if(!!$){if(m(f)&&k)u.parse(k);else if(d(f)){const o=await n.run(f,{console:i},k).catch(p=>(i.error(`Failed to execute Molang AST script "${f}": ${p}`),null));if(!o)return null;typeof o.__default__=="function"&&v.push(o.__default__)}}},async require(f){if(!!$&&F(f))return[l("behaviorPack","scripts/molang/**/*.[jt]s"),l("behaviorPack","molang/**/*.molang"),l("resourcePack","molang/**/*.molang")]},async transform(f,k){if(!$)return;const o=F(f);o&&o.length>0&&o.forEach(p=>C.setObjectAt(p,k,h=>{if(typeof h!="string"||h[0]==="/"||h[0]==="@")return h;if(v.length>0){let y=null;try{y=u.parse(h)}catch(S){s.buildType!=="fileRequest"&&i.error(`Error within file "${f}"; script "${h}": ${S}`)}if(y){for(const S of v)y=y.walk(S);h=y.toString()}}try{return u.transform(h)}catch(y){return s.buildType!=="fileRequest"&&i.error(`Error within file "${f}"; script "${h}": ${y}`),h}}))},finalizeBuild(f,k){if(F(f)&&typeof k!="string")return JSON.stringify(k,null,"	")},buildEnd(){v=[]}}},ce=({fileType:a})=>({ignore(e){return(a==null?void 0:a.getId(e))!=="entity"},registerAliases(e,t){var s,i,n,r;if((a==null?void 0:a.getId(e))==="entity"&&((i=(s=t==null?void 0:t["minecraft:entity"])==null?void 0:s.description)==null?void 0:i.identifier))return[(r=(n=t==null?void 0:t["minecraft:entity"])==null?void 0:n.description)==null?void 0:r.identifier]}});function ue(a,e){const t=L(a),s=L(e),i=t.pop(),n=s.pop(),r=G(t,s);return r!==0?r:i&&n?G(i.split("."),n.split(".")):i||n?i?-1:1:0}const de=(a,e,t)=>{fe(t);const s=ue(a,e);return K[t].includes(s)},he=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,L=a=>{if(typeof a!="string")throw new TypeError("Invalid argument expected string");const e=a.match(he);if(!e)throw new Error(`Invalid argument not valid semver ('${a}' received)`);return e.shift(),e},V=a=>a==="*"||a==="x"||a==="X",U=a=>{const e=parseInt(a,10);return isNaN(e)?a:e},me=(a,e)=>typeof a!=typeof e?[String(a),String(e)]:[a,e],pe=(a,e)=>{if(V(a)||V(e))return 0;const[t,s]=me(U(a),U(e));return t>s?1:t<s?-1:0},G=(a,e)=>{for(let t=0;t<Math.max(a.length,e.length);t++){const s=pe(a[t]||0,e[t]||0);if(s!==0)return s}return 0},K={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]},X=Object.keys(K),fe=a=>{if(typeof a!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof a}`);if(X.indexOf(a)===-1)throw new Error(`Invalid operator, expected one of ${X.join("|")}`)},ge=(a,e)=>({register:t=>{var s;((s=t.type)!=null?s:"entity")===e&&(a.component=({name:i,schema:n,template:r})=>{const l=new t;i(t.component_name),n(N(Object.values(l.onPropose())[0])),r((u,{create:c})=>{c(l.onApply(u,"components")[`minecraft:${e}`])})})}});function N(a){const e={},t=Object.keys(a);if(t.length===1&&t[0].startsWith("$dynamic.list."))return{type:"array",items:N(Object.values(a)[0])};for(const[s,i]of Object.entries(a))s.startsWith("$")||(typeof i=="string"?e[s]=ye(i):Array.isArray(i)?e[s]={enum:i}:i==="object"&&(e[s]=N(i)));return{type:"object",properties:e}}function ye(a){switch(a){case"$general.boolean":return{type:"boolean"};case"$general.number":return{type:"integer"};case"$general.decimal":return{type:"number"};default:return{type:["number","integer","string","boolean","object","array"]}}}class Q{constructor(e,t,s,i,n,r){this.console=e,this.fileType=t,this.componentSrc=s,this.mode=i,this.v1Compat=n,this.targetVersion=r,this.animations=[],this.animationControllers=[],this.createOnPlayer=[],this.dialogueScenes={},this.serverFiles=[],this.clientFiles={},this.lifecycleHookCount={activated:0,deactivated:0}}setProjectConfig(e){this.projectConfig=e}get name(){return this._name}async load(e,t,s){let i={component:null};const n=await e.run(t,{defineComponent:c=>c,console:this.console,Bridge:this.v1Compat?ge(i,this.fileType):void 0}).catch(c=>(this.console.error(`Failed to execute component "${t}": ${c}`),null));if(!n)return!1;if(typeof n.__default__!="function")if(i.component)n.__default__=i.component;else return this.console.error(`Component ${t} is not a valid component. Expected a function as the default export.`),!1;const r=c=>this._name=c;let l=c=>this.schema=c,u=()=>{};return(!s||s==="server")&&(l=()=>{},u=c=>{this.template=(m,g)=>{try{c(m,g)}catch(d){this.console.log(c.toString()),this.console.error(d)}}}),await n.__default__({name:r,schema:l,template:u}),!0}reset(){this.animations=[],this.animationControllers=[],this.clientFiles={},this.serverFiles=[]}getSchema(){return this.schema}toString(){return this.componentSrc}create(e,t,s=`minecraft:${this.fileType}`,i){var u;const n=s.split("/"),r=n.pop(),l=this.getObjAtLocation(e,[...n]);l[r]=(i?(c,m)=>i(C.deepMerge,c,m):C.deepMerge)((u=l[r])!=null?u:{},t!=null?t:{})}getObjAtLocation(e,t){let s=e;for(;t.length>0;){const i=t.shift();s[i]===void 0?s[Number(i)]!==void 0?s=s[Number(i)]:(s[i]={},s=s[i]):s=s[i]}return s}async processTemplates(e,t,s){var $,b,f,k,o,p;if(typeof this.template!="function")return;const i=(f=(b=($=e[`minecraft:${this.fileType}`])==null?void 0:$.description)==null?void 0:b.identifier)!=null?f:"bridge:no_identifier",n=await C.hashString(`${this.name}/${i}`),r=(p=(o=(k=this.projectConfig)==null?void 0:k.get())==null?void 0:o.namespace)!=null?p:"bridge",l=(h,y)=>(this.animations.push([h,y]),this.getShortAnimName("a",n,this.animations.length-1)),u=(h,y)=>(this.animationControllers.push([h,y]),this.getShortAnimName("ac",n,this.animationControllers.length-1)),c=h=>{const y=`loot_tables/bridge/${this.getShortAnimName("lt",n,this.serverFiles.length)}.json`;return this.serverFiles.push([y,h]),y},m=h=>{const y=`trading/bridge/${this.getShortAnimName("tt",n,this.serverFiles.length)}.json`;return this.serverFiles.push([y,h]),y},g=h=>{this.serverFiles.push([`recipes/bridge/${this.getShortAnimName("recipe",n,this.serverFiles.length)}.json`,h])},d=h=>{this.serverFiles.push([`spawn_rules/bridge/${this.getShortAnimName("sr",n,this.serverFiles.length)}.json`,h])},w=(await C.hashString(`${this.name}/${s}`)).slice(0,16),F=h=>this.registerLifecycleHook(e,s,h,w,"activated"),v=h=>this.registerLifecycleHook(e,s,h,w,"deactivated");this.fileType==="entity"?this.template(t!=null?t:{},{mode:this.mode,compilerMode:this.mode,sourceEntity:()=>JSON.parse(JSON.stringify(e)),create:(h,y,S)=>this.create(e,h,y,S),location:s,identifier:i,projectNamespace:r,animationController:u,animation:l,lootTable:c,tradeTable:m,spawnRule:d,dialogueScene:!this.targetVersion||de(this.targetVersion,"1.17.10",">=")?(h,y=!0)=>{this.dialogueScenes[n]||(this.dialogueScenes[n]=[]),this.dialogueScenes[n].push(h),h.scene_tag&&y&&F({run_command:{command:[`/dialogue open @s @p ${h.scene_tag}`]}})}:void 0,onActivated:F,onDeactivated:v,client:{create:(h,y="1.10.0")=>{this.clientFiles[`entity/bridge/${n}.json`]={format_version:y,"minecraft:client_entity":Object.assign({description:{identifier:i}},h)}}}}):this.fileType==="item"?this.template(t!=null?t:{},{mode:this.mode,compilerMode:this.mode,sourceItem:()=>JSON.parse(JSON.stringify(e)),create:(h,y,S)=>this.create(e,h,y,S),location:s,identifier:i,projectNamespace:r,lootTable:c,recipe:g,player:{animationController:u,animation:l,create:(h,y,S)=>this.createOnPlayer.push([y!=null?y:"minecraft:entity",h,S])}}):this.fileType==="block"&&this.template(t!=null?t:{},{mode:this.mode,compilerMode:this.mode,sourceBlock:()=>JSON.parse(JSON.stringify(e)),create:(h,y,S)=>this.create(e,h,y,S),lootTable:c,recipe:g,location:s,identifier:i,projectNamespace:r})}async processAdditionalFiles(e,t){var c,m,g,d,w,F;const s=(m=(c=this.projectConfig)==null?void 0:c.getRelativePackRoot("behaviorPack"))!=null?m:"BP",i=(g=this.projectConfig)==null?void 0:g.getRelativePackRoot("resourcePack"),n=(F=(w=(d=t[`minecraft:${this.fileType}`])==null?void 0:d.description)==null?void 0:w.identifier)!=null?F:"bridge:no_identifier",r=await C.hashString(`${this.name}/${n}`),l=`${s}/animations/bridge/${r}.json`,u=`${s}/animation_controllers/bridge/${r}.json`;return n==="minecraft:player"&&this.createOnPlayer.forEach(([v,$,b])=>{this.create(t,$,v,b)}),i||(this.clientFiles={},this.console.error(`[${this.name}] Dash was unable to load the root of your resource pack and therefore cannot generate client files for this component.`)),{[l]:{baseFile:e,fileContent:this.createAnimations(r,t)},[u]:{baseFile:e,fileContent:this.createAnimationControllers(r,t)},[j.join(s,`dialogue/bridge/${r}.json`)]:this.dialogueScenes[r]&&this.dialogueScenes[r].length>0?{baseFile:e,fileContent:JSON.stringify({format_version:this.targetVersion,"minecraft:npc_dialogue":{scenes:this.dialogueScenes[r]}},null,"	")}:void 0,...Object.fromEntries(this.serverFiles.map(([v,$])=>[j.join(s,v),{baseFile:e,fileContent:JSON.stringify($,null,"	")}])),...Object.fromEntries(Object.entries(this.clientFiles).map(([v,$])=>[j.join(i,v),{baseFile:e,fileContent:JSON.stringify($,null,"	")}]))}}createAnimations(e,t){if(this.animations.length===0)return;let s=0;const i={format_version:"1.10.0",animations:{}};for(const[n,r]of this.animations){if(!n){s++;continue}const l=this.getAnimName("animation",e,s),u=this.getShortAnimName("a",e,s);i.animations[l]=n,this.create(t,{animations:{[u]:l}},"minecraft:entity/description"),r!==!1&&this.create(t,{scripts:{animate:[r?{[u]:r}:u]}},"minecraft:entity/description"),s++}return JSON.stringify(i,null,"	")}createAnimationControllers(e,t){if(this.animationControllers.length===0)return;let s=0;const i={format_version:"1.10.0",animation_controllers:{}};for(const[n,r]of this.animationControllers){if(!n){s++;continue}const l=this.getAnimName("controller.animation",e,s),u=this.getShortAnimName("ac",e,s);i.animation_controllers[l]=n,this.create(t,{animations:{[u]:l}},"minecraft:entity/description"),r!==!1&&this.create(t,{scripts:{animate:[r?{[u]:r}:u]}},"minecraft:entity/description"),s++}return JSON.stringify(i,null,"	")}getAnimName(e,t,s){return`${e}.${t}_${s}`}getShortAnimName(e,t,s){var i;return`${(i=t.slice(0,16))!=null?i:"bridge_auto"}_${e}_${s}`}registerLifecycleHook(e,t,s,i,n){e[`minecraft:${this.fileType}`].events||(e[`minecraft:${this.fileType}`].events={});const r=e[`minecraft:${this.fileType}`].events;if(n==="activated"&&t===`minecraft:${this.fileType}/components`)r["minecraft:entity_spawned"]||(r["minecraft:entity_spawned"]={}),this.addEventReponse(r["minecraft:entity_spawned"],s);else if(this.fileType==="entity"&&t.startsWith(`minecraft:${this.fileType}/component_groups/`)){const l=t.split("/").pop();this.findComponentGroupReferences(r,n==="activated"?"add":"remove",l).forEach(c=>this.addEventReponse(c,s))}else if(t.startsWith(`minecraft:${this.fileType}/permutations/`)){const l=t.split("/");if(l.pop()!=="components")throw new Error("Invalid component location inside of permutation");const u=this.getObjAtLocation(e,[...l]),c=`bridge:${i}_${n}_${n==="activated"?this.lifecycleHookCount.activated++:this.lifecycleHookCount.deactivated++}`;u.condition&&this.animationControllers.push([{states:{default:{on_entry:[`@s ${c}`]}}},n==="activated"?u.condition:`!(${u.condition})`]),r[c]=s}}addEventReponse(e,t){if(Array.isArray(e.sequence))e.sequence.push(t);else if(Object.keys(e).length===0)Object.assign(e,t);else{let s=Object.assign({},e,{filters:void 0});for(const i in e)i!=="filters"&&(e[i]=void 0);e.sequence=[s,t]}}findComponentGroupReferences(e,t,s){var n,r;let i=[];for(const l in e){const u=e[l];Array.isArray(u.sequence)?i.push(...this.findComponentGroupReferences(u.sequence,t,s)):Array.isArray(u.randomize)?i.push(...this.findComponentGroupReferences(u.randomize,t,s)):((r=(n=u[t])==null?void 0:n.component_groups)!=null?r:[]).includes(s)&&i.push(u)}return i}}function we(a){const e=[];for(const[t,s]of a)e.push(...Fe(s,t));return e}function Fe(a,e){const t=[];for(const s in a)s.startsWith("minecraft:")||s.startsWith("tag:")||t.push([s,e]);return t}function x({fileType:a,getComponentObjects:e}){const t=new Map;let s={};return({console:i,projectConfig:n,projectRoot:r,compileFiles:l,getAliases:u,options:c,jsRuntime:m,targetVersion:g,fileType:d})=>{let w=null;const F=(o,p)=>{if(!o)return!1;if(w&&o===w)return!0;const h=a==="item"&&(d==null?void 0:d.getId(o))==="entity"&&p(o).includes("minecraft:player");return h&&(w=o),h},v=new Map,$=o=>{if(!o)return!1;if(v.has(o))return v.get(o);const p=c.v1CompatMode?o.includes("/components/"):(d==null?void 0:d.getId(o))==="customComponent"&&o.includes(`/${a}/`);return v.set(o,p),p},b=new Map,f=o=>{if(!o)return!1;if(b.has(o))return b.get(o);const p=(d==null?void 0:d.getId(o))===a;return b.set(o,p),p};let k=!1;return{buildStart(){t.clear(),v.clear(),b.clear(),w=null,s={},k=!1},ignore(o){return!s[o]&&!$(o)&&!f(o)&&!F(o,u)},transformPath(o){if($(o)&&c.buildType!=="fileRequest")return null},async read(o,p){if(!p)return s[o]?T.default.parse(s[o].fileContent):void 0;if($(o)&&o.endsWith(".js")){k=!0;const h=await p.getFile();return await(h==null?void 0:h.text())}else if(f(o)||F(o,u)){const h=await p.getFile();if(!h)return;try{return T.default.parse(await h.text())}catch(y){return c.buildType!=="fileRequest"&&i.error(`Error within file "${o}": ${y}`),{__error__:`Failed to load original file: ${y}`}}}},async load(o,p){if(!!k&&$(o)&&typeof p=="string"){const h=new Q(i,a,p,c.mode,!!c.v1CompatMode,g);return h.setProjectConfig(n),await h.load(m,o)?h:p}},async registerAliases(o,p){if(!!k&&$(o))return[`${a}Component#${p.name}`]},async require(o,p){if(!!k){if(F(o,u))return[`.${n.getRelativePackRoot("behaviorPack")}/components/item/**/*.[jt]s`,`.${n.getRelativePackRoot("behaviorPack")}/items/**/*.json`];if(f(o)){const h=we(e(p));return t.set(o,h),h.map(y=>`${a}Component#${y[0]}`)}else if(s[o])return[s[o].baseFile]}},async transform(o,p,h={}){var y;if(!!k){if(F(o,u)){const S=Object.entries(h).filter(([_])=>_.startsWith("itemComponent#")).map(([_,I])=>I);for(const _ of S){if(!_)return;s=C.deepMerge(s,await _.processAdditionalFiles(o,p))}}else if(f(o)){const S=new Set;for(const[_,I]of(y=t.get(o))!=null?y:[]){const q=h[`${a}Component#${_}`];if(!q)continue;const R=C.get(p,I.split("/"),{}),H=R[_];delete R[_],await q.processTemplates(p,H,I),S.add(q)}for(const _ of S)s=C.deepMerge(s,await _.processAdditionalFiles(o,p));for(const _ of S)_.reset()}}},finalizeBuild(o,p){if(!!k){if($(o)&&p)return p.toString();if(f(o)||s[o])return JSON.stringify(p,null,"	")}},async buildEnd(){if(!k||c.buildType==="fileRequest")return;s=Object.fromEntries(Object.entries(s).filter(([p,h])=>(h==null?void 0:h.fileContent)!==void 0).map(([p,h])=>[j.join(r,p),h]));const o=Object.keys(s);o.length>0&&await l(o),s={}}}}}const ke=x({fileType:"entity",getComponentObjects:a=>{var e,t,s,i,n,r;return[["minecraft:entity/components",(t=(e=a==null?void 0:a["minecraft:entity"])==null?void 0:e.components)!=null?t:{}],...Object.entries((i=(s=a==null?void 0:a["minecraft:entity"])==null?void 0:s.component_groups)!=null?i:{}).map(([l,u])=>[`minecraft:entity/component_groups/${l}`,u]),...((r=(n=a==null?void 0:a["minecraft:entity"])==null?void 0:n.permutations)!=null?r:[]).map((l,u)=>{var c;return[`minecraft:entity/permutations/${u}/components`,(c=l==null?void 0:l.components)!=null?c:{}]})]}}),ve=x({fileType:"item",getComponentObjects:a=>{var e,t;return[["minecraft:item/components",(t=(e=a==null?void 0:a["minecraft:item"])==null?void 0:e.components)!=null?t:{}]]}}),$e=x({fileType:"block",getComponentObjects:a=>{var e,t,s,i;return[["minecraft:block/components",(t=(e=a==null?void 0:a["minecraft:block"])==null?void 0:e.components)!=null?t:{}],...((i=(s=a==null?void 0:a["minecraft:block"])==null?void 0:s.permutations)!=null?i:[]).map((n,r)=>{var l;return[`minecraft:block/permutations/${r}/components`,(l=n.components)!=null?l:{}]})]}});function W(a,e,t,s=0){const i=[];for(const n of a){if(!n.startsWith("/")){i.push(n);continue}const[r,...l]=C.tokenizeCommand(n.slice(1)).tokens.map(({word:c})=>c),u=e[`command#${r}`];if(r==="execute"){let c=4;if(l[c]==="detect"&&(c+=6),l[c]===void 0){i.push(n);continue}const[m,...g]=l.slice(c),d=e[`command#${m}`];if(!(d instanceof E)){i.push(n);continue}i.push(...d.process(`${m} ${g.join(" ")}`,e,s+1).map(w=>w.startsWith("/")?`/execute ${l.slice(0,c).join(" ")} ${w.slice(1)}`:w));continue}else if(!(u instanceof E)){i.push(n);continue}i.push(...u.process(n,e,s))}return i.filter(n=>t||!n.startsWith("#")).map(n=>n.trim())}const be=a=>({register:e=>{a.command=({name:t,schema:s,template:i})=>{t(e.command_name),s([]),i(n=>new e().onApply(n))}}});class E{constructor(e,t,s,i){this.console=e,this.commandSrc=t,this.mode=s,this.v1Compat=i}get name(){var e;return(e=this._name)!=null?e:"unknown"}async load(e,t,s){const i={command:null},n=await e.run(t,{console:this.console,defineCommand:c=>c,Bridge:this.v1Compat?be(i):void 0}).catch(c=>(this.console.error(`Failed to execute command ${this.name}: ${c}`),null));if(!n)return null;if(typeof n.__default__!="function")if(i.command)n.__default__=i.command;else return this.console.error(`Component ${t} is not a valid component. Expected a function as the default export.`),!1;const r=c=>this._name=c;let l=c=>this.schema=c,u=()=>{};(!s||s==="server")&&(l=()=>{},u=c=>{this.template=(m,g)=>{try{return c(m,g)}catch(d){return this.console.error(d),[]}}}),await n.__default__({name:r,schema:l,template:u})}process(e,t,s){var u;e.startsWith("/")&&(e=e.slice(1));const[i,...n]=C.tokenizeCommand(e).tokens.map(({word:c})=>c),r=(u=this.template)==null?void 0:u.call(this,n.map(c=>C.castType(c)),{compilerMode:this.mode,commandNestingDepth:s,compileCommands:c=>W(c.map(m=>m.startsWith("/")?m:`/${m}`),t,!1,s+1).map(m=>m.startsWith("/")?m.slice(1):m)});let l=[];if(typeof r=="string")l=r.split(`
`);else if(Array.isArray(r))l=r.filter(c=>typeof c=="string");else{const c=`Failed to process command ${this._name}; Invalid command template return type: Expected string[] or string, received ${typeof r}`;this.console.error(c),l.push(`# ${c}`)}return l.map(c=>c.startsWith("/")||c.startsWith("#")?c:`/${c}`)}getSchema(){if(this.schema){if(Array.isArray(this.schema))return this.schema.length===0?[{commandName:this.name}]:this.schema.map(e=>({commandName:this.name,...e}))}else return[{commandName:this.name}];return this.schema.commandName||(this.schema.commandName=this.name),[this.schema]}toString(){return this.commandSrc}}const Se=({projectConfig:a,jsRuntime:e,console:t,fileType:s,requestJsonData:i,options:n})=>{const r=(d,w)=>a.resolvePackPath(d,w),l=d=>d&&s.getId(d)==="customCommand",u=d=>d&&s.getId(d)==="function",c=new Map,m=d=>{if(c.has(d))return c.get(d);const w=n.include[s.getId(d)];return c.set(d,w),w},g=d=>{var w,F,v;return(v=(F=(w=s.get(d))==null?void 0:w.meta)==null?void 0:F.commandsUseSlash)!=null?v:!1};return{async buildStart(){n.include=Object.assign(await i("data/packages/minecraftBedrock/location/validCommand.json"),n.include),c.clear()},ignore(d){return!l(d)&&!u(d)&&!m(d)},transformPath(d){if(l(d)&&n.buildType!=="fileRequest")return null},async read(d,w){if(!!w){if(l(d)&&d.endsWith(".js")){const F=await w.getFile();return await(F==null?void 0:F.text())}else if(u(d)){const F=await w.getFile();return await(F==null?void 0:F.text())}else if(m(d)&&w){const F=await w.getFile();if(!F)return;try{return T.default.parse(await F.text())}catch(v){t.error(v)}}}},async load(d,w){var F;if(l(d)){const v=new E(t,w,n.mode,(F=n.v1CompatMode)!=null?F:!1);return await v.load(e,d),v}},async registerAliases(d,w){if(l(d))return[`command#${w.name}`]},async require(d){if(m(d)||u(d))return[r("behaviorPack","commands/**/*.[jt]s"),r("behaviorPack","commands/*.[jt]s")]},async transform(d,w,F={}){const v=m(d);if(v&&v.length>0){const $=g(d);v.forEach(b=>C.setObjectAt(b,w,f=>{if(!f)return f;f=Array.isArray(f)?f:[f];const k=[];for(const o of f){if(typeof o=="string"){k.push(o);continue}t.error(`The file "${d}" contains invalid commands. Expected type "string" within array but got type "${typeof o}"`)}return W(k.map(o=>!$&&!o.startsWith("/")?`/${o}`:o),F,!1).map(o=>$?o:o.slice(1))}))}else if(u(d)){const $=w.split(`
`).map(b=>b.trim()).filter(b=>b!==""&&!b.startsWith("#")).map(b=>`/${b}`);return W($,F,!0).map(b=>b.startsWith("/")?b.slice(1):b).join(`
`)}},finalizeBuild(d,w){if(l(d)&&w)return w.toString();if(m(d)&&typeof w!="string")return JSON.stringify(w,null,"	")}}},je=({options:a})=>({ignore(e){return!e.endsWith(".ts")},async transformPath(e){if(!!(e!=null&&e.endsWith(".ts")))return`${e.slice(0,-3)}.js`},async read(e,t){if(!e.endsWith(".ts")||!t)return;const s=await t.getFile();return await(s==null?void 0:s.text())},async load(e,t){if(!!e.endsWith(".ts"))return await D.loadedWasm,ie.transformSync(t,{filename:j.basename(e),sourceMaps:a!=null&&a.inlineSourceMap?"inline":void 0,jsc:{parser:{syntax:"typescript",preserveAllComments:!1,topLevelAwait:!0},target:"es2020"}}).code},finalizeBuild(e,t){if(e.endsWith(".ts")&&typeof t=="string")return t}}),_e=({options:a,outputFileSystem:e,projectRoot:t,packType:s,fileType:i,console:n})=>{a.packName||(a.packName="bridge project");const r=m=>m.split(/\\|\//g).filter(g=>g!==".."&&g!==".").slice(1).join("/"),l=m=>{const g=s.getId(m),d=j.relative(t,m);if(g==="behaviorPack"||g==="resourcePack"||g==="skinPack")return j.join(t,"builds/dist",g,r(d))},u=m=>{const g=s.getId(m),d=j.relative(t,m);if(g==="worldTemplate")return j.join(t,"builds/dist",r(d));if(g==="behaviorPack"||g==="resourcePack")return j.join(t,"builds/dist",g==="behaviorPack"?"behavior_packs":"resource_packs",a.packName,r(d))},c=m=>i.getId(m)==="worldManifest"?null:u(m);return{async buildStart(){await e.unlink(`${t}/builds/dist`).catch(()=>{})},transformPath(m){if(!!m)switch(a.format){case"mcaddon":return l(m);case"mcworld":return c(m);case"mctemplate":return u(m);default:n.error(`Unknown packaging format: ${a.format}`)}}}},Ae=({projectConfig:a,packType:e,options:t})=>{const s=Object.keys(a.getAvailablePacks()),i=Object.fromEntries(s.map(r=>[r,[]])),n=r=>{const l=e.getId(r);if(l!=="unknown")return[l,a.resolvePackPath(l,"contents.json")]};return t.buildType!=="fullBuild"?{}:{include(){return s.map(r=>[a.resolvePackPath(r,"contents.json"),{isVirtual:!0}])},read(r){const l=n(r);if(!l)return;const[u,c]=l;if(r!==c)return i[u]},transformPath(r){if(!r)return;const l=e.getId(r);l!=="unknown"&&i[l].push(r)},finalizeBuild(r){const l=n(r);if(!l)return;const[u,c]=l;if(r!==c)return JSON.stringify(i[u])}}},Ce=({fileType:a})=>{const e=new Set;for(const i of a.all)i.formatVersionMap&&e.add(i.id);const t=new Map,s=i=>{if(!i)return;let n=t.get(i);return n||(n=e.has(a.getId(i)),t.set(i,n),n)};return{ignore(i){return!s(i)},async read(i,n){if(!!n&&s(i)){const r=await n.getFile();if(!r)return;try{return T.default.parse(await r.text())}catch(l){console.error(l)}}},load(i,n){if(s(i))return n},transform(i,n){if(s(i)){const r=a.get(i),l=r==null?void 0:r.formatVersionMap;if(!l)return;const u=n==null?void 0:n.format_version;return u&&l[u]&&(n.format_version=l[u]),n}},finalizeBuild(i,n){if(s(i))return JSON.stringify(n)}}};class J{constructor(e,t){this.console=e,this.baseDir=t,this.files=new Map}get hasFiles(){return this.files.size>0}getAll(){return[...this.files.entries()]}get(e){return this.files.get(e)}clear(){this.files.clear()}add(e,t){const s=this.baseDir?j.join(this.baseDir,e):e;if(this.files.has(s)){this.console.warn(`Omitting file "${s}" from collection because it would overwrite a previously generated file!`);return}this.files.set(s,t)}has(e){return this.files.has(e)}addFrom(e){for(const[t,s]of e.getAll())this.add(t,s)}}function Ie({generatorPath:a,omitUsedTemplates:e,fileSystem:t,console:s}){return{useTemplate:(i,{omitTemplate:n=!0}={})=>{const r=j.join(j.dirname(a),i);return n&&e.add(r),i.endsWith(".json")?t.readJson(r):t.readFile(r).then(l=>l.text())},createCollection:()=>new J(s,j.dirname(a))}}const He=({options:a,fileType:e,console:t,jsRuntime:s,fileSystem:i,compileFiles:n,getFileMetadata:r,unlinkOutputFiles:l,addFileDependencies:u})=>{var k;const c=new Set(["gameTest","customCommand","customComponent","molangAstScript",...(k=a.ignoredFileTypes)!=null?k:[]]),m=o=>e.getId(o),g=o=>{var h;const p=e.get(o,void 0,!1);return p?(h=p.type)!=null?h:"json":"raw"},d=o=>!c.has(m(o))&&(o.endsWith(".js")||o.endsWith(".ts")),w=o=>{var h,y,S,_;return g(o)==="json"?".json":(_=(S=(y=(h=e.get(o,void 0,!1))==null?void 0:h.detect)==null?void 0:y.fileExtensions)==null?void 0:S[0])!=null?_:".txt"},F=o=>o.replace(/\.(js|ts)$/,w(o)),v=new Set,$=new J(t),b=new Set,f=new Map;return{buildStart(){$.clear(),v.clear(),b.clear(),f.clear()},ignore(o){return!d(o)&&!v.has(o)&&!$.has(o)},transformPath(o){if(o&&d(o))return F(o)},async read(o,p){if(d(o)&&p){const y=await p.getFile();return y?y.text():void 0}const h=$.get(o);if(h)return h},async load(o,p){var h,y;if(d(o)){if(!p)return null;const S=new Set;s.registerModule("@bridge/generate",Ie({generatorPath:o,fileSystem:i,omitUsedTemplates:S,console:t}));const _=await s.run(o,{console:t},p).catch(H=>(t.error(`Failed to execute generator script "${o}": ${H}`),null));if(!_)return null;if(!_.__default__)return t.error(`Expected generator script "${o}" to provide file content as default export!`),null;const I=r(o);((h=I.get("unlinkedFiles"))!=null?h:[]).filter(H=>!S.has(H)).forEach(H=>b.add(H)),I.set("unlinkedFiles",[...S]);const R=(y=I.get("generatedFiles"))!=null?y:[];return await l([...R,...S]).catch(()=>{}),f.set(o,S),_.__default__}},require(o){const p=f.get(o);if(p)return[...p]},finalizeBuild(o,p){if($.get(o))return o.endsWith(".json")&&typeof p!="string"?JSON.stringify(p,null,"	"):p;if(v.has(o))return null;if(d(o)){if(p===null)return null;const h=r(o);return p instanceof J?($.addFrom(p),h.set("generatedFiles",p.getAll().map(([y])=>y)),null):(h.set("generatedFiles",[F(o)]),typeof p=="object"?JSON.stringify(p):p)}},async buildEnd(){s.deleteModule("@bridge/generate"),b.size>0&&await n([...b].filter(o=>!$.has(o)),!1),$.hasFiles&&await n($.getAll().map(([o])=>o))},async beforeFileUnlinked(o){var p,h;if(d(o)){let y=null;try{y=r(o)}catch{}if(!y)return;const S=(p=y.get("unlinkedFiles"))!=null?p:[],_=(h=y.get("generatedFiles"))!=null?h:[];await l(_),await n(S)}}}};class Y extends D.Runtime{constructor(e,t){super(t),this.fs=e}readFile(e){return this.fs.readFile(e).then(t=>t.text())}deleteModule(e){this.baseModules.delete(e)}}const Z={simpleRewrite:le,rewriteForPackaging:_e,moLang:z,molang:z,entityIdentifierAlias:ce,customEntityComponents:ke,customItemComponents:ve,customBlockComponents:$e,customCommands:Se,typeScript:je,contentsFile:Ae,formatVersionCorrection:Ce,generatorScripts:He},Te=["buildStart","buildEnd","include","ignore","transformPath","read","load","registerAliases","require","transform","finalizeBuild","beforeFileUnlinked"];class Me{constructor(e){this.dash=e,this.implementedHooks=new Map,this.pluginRuntime=new Y(this.dash.fileSystem)}pluginsFor(e,t){var s,i;return t?(s=t.myImplementedHooks.get(e))!=null?s:[]:(i=this.implementedHooks.get(e))!=null?i:[]}getImplementedHooks(){return this.implementedHooks}async loadPlugins(e={}){var u;this.implementedHooks.clear(),this.pluginRuntime.clearCache();const t=[...(await this.dash.fileSystem.readdir(j.join(this.dash.projectRoot,".bridge/extensions")).catch(()=>[])).map(c=>c.kind==="directory"?j.join(this.dash.projectRoot,".bridge/extensions",c.name):void 0),...(await this.dash.fileSystem.readdir("extensions").catch(()=>[])).map(c=>c.kind==="directory"?j.join("extensions",c.name):void 0)],s={},i=[];for(const c of t)!c||i.push(this.dash.fileSystem.readJson(j.join(c,"manifest.json")).then(m=>{var g;if(!!((g=m==null?void 0:m.compiler)!=null&&g.plugins))for(const d in m.compiler.plugins)s[d]=j.join(c,m.compiler.plugins[d])}).catch(()=>{}));await Promise.all(i);const n=(u=(await this.getCompilerOptions()).plugins)!=null?u:[],r=[],l=[];for(let c=0;c<n.length;c++){const m=n[c],g=typeof m=="string"?m:m[0];s[g]?l.push(this.pluginRuntime.run(s[g],{console:this.dash.console,...e}).catch(d=>(this.dash.console.error(`Failed to execute plugin ${g}: ${d}`),null)).then(d=>{!d||(typeof d.__default__=="function"?r[c]=d.__default__:(r[c]=null,this.dash.console.error(`Plugin ${g} is invalid: It does not provide a function as a default export.`)))})):Z[g]?r[c]=Z[g]:(r[c]=null,this.dash.console.error(`Unknown compiler plugin: ${g}`))}await Promise.all(l);for(let c=0;c<n.length;c++){const m=r[c];if(!m)continue;const g=n[c],d=typeof g=="string"?{}:g[1],w=typeof g=="string"?g:g[0];this.addPlugin(w,m,d)}}async addPlugin(e,t,s){const i=new oe(this.dash,e,await t(this.getPluginContext(e,s)));for(const n of Te)if(i.implementsHook(n)){let r=this.implementedHooks.get(n);r||(r=[],this.implementedHooks.set(n,r)),r.push(i)}}async getCompilerOptions(){var t;const e=await this.dash.getCompilerConfigPath();return e?await this.dash.fileSystem.readJson(e):(t=this.dash.projectConfig.get().compiler)!=null?t:{}}getPluginContext(e,t={}){const s=this.dash;return{options:{get mode(){return s.getMode()},get buildType(){return s.buildType},...t},jsRuntime:this.dash.jsRuntime,console:this.dash.console,fileSystem:this.dash.fileSystem,outputFileSystem:this.dash.outputFileSystem,projectConfig:this.dash.projectConfig,projectRoot:this.dash.projectRoot,packType:this.dash.packType,fileType:this.dash.fileType,targetVersion:this.dash.projectConfig.get().targetVersion,requestJsonData:this.dash.requestJsonData,getAliases:i=>{var n,r;return[...(r=(n=this.dash.includedFiles.get(i))==null?void 0:n.aliases)!=null?r:[]]},getFileMetadata:i=>{const n=this.dash.includedFiles.get(i);if(!n)throw new Error(`File ${i} to get metadata from not found`);return{get(r){return n.getMetadata(r)},set(r,l){n.addMetadata(r,l)},delete(r){n.deleteMetadata(r)}}},addFileDependencies:(i,n,r=!1)=>{const l=this.dash.includedFiles.get(i);if(!l)throw new Error(`File ${i} to add dependency to not found`);r?l.setRequiredFiles(new Set(n)):n.forEach(u=>l.addRequiredFile(u))},getOutputPath:i=>this.dash.getCompilerOutputPath(i),unlinkOutputFiles:i=>this.dash.unlinkMultiple(i,!1,!0),hasComMojangDirectory:this.dash.fileSystem!==this.dash.outputFileSystem,compileFiles:(i,n=!0)=>this.dash.compileAdditionalFiles(i,n)}}async runBuildStartHooks(){await Promise.all(this.pluginsFor("buildStart").map(e=>e.runBuildStartHook()))}async runIncludeHooks(){let e=[];for(const t of this.pluginsFor("include")){const s=await t.runIncludeHook();Array.isArray(s)&&e.push(...s)}return e}async runIgnoreHooks(e){for(const t of this.pluginsFor("ignore"))await t.runIgnoreHook(e.filePath)&&e.addIgnoredPlugin(t.pluginId);e.createImplementedHooksMap()}async runTransformPathHooks(e){let t=e.filePath;for(const s of this.pluginsFor("transformPath")){const i=await s.runTransformPathHook(t);if(i===null)return null;i!==void 0&&(t=i)}return t}async runReadHooks(e){for(const t of this.pluginsFor("read",e)){const s=await t.runReadHook(e.filePath,e.fileHandle);if(s!=null)return s}}async runLoadHooks(e){let t=e.data;for(const s of this.pluginsFor("load",e)){const i=await s.runLoadHook(e.filePath,t);i!==void 0&&(t=i)}return t}async runRegisterAliasesHooks(e){const t=new Set;for(const s of this.pluginsFor("registerAliases",e)){const i=await s.runRegisterAliasesHook(e.filePath,e.data);i!=null&&(Array.isArray(i)?i.forEach(n=>t.add(n)):t.add(i))}return t}async runRequireHooks(e){const t=new Set;for(const s of this.pluginsFor("require",e)){const i=await s.runRequireHook(e.filePath,e.data);i!=null&&(Array.isArray(i)?i.forEach(n=>t.add(n)):t.add(i))}return t}async runTransformHooks(e){const t=Object.fromEntries([...e.requiredFiles].map(i=>this.dash.includedFiles.query(i)).flat().map(i=>[[i.filePath,i.data],...[...i.aliases].map(n=>[n,i.data])]).flat());let s=e.data;for(const i of this.pluginsFor("transform",e)){const n=await i.runTransformHook(e.filePath,s,t);n!==void 0&&(s=n)}return s}async runFinalizeBuildHooks(e){for(const t of this.pluginsFor("finalizeBuild",e)){const s=await t.runFinalizeBuildHook(e.filePath,e.data);if(s!==void 0)return s}}async runBuildEndHooks(){await Promise.allSettled(this.pluginsFor("buildEnd").map(e=>e.runBuildEndHook()))}async runBeforeFileUnlinked(e){for(const t of this.pluginsFor("beforeFileUnlinked"))await t.runBeforeFileUnlinked(e)}}class P{constructor(e,t,s=!1){this.dash=e,this.filePath=t,this.isVirtual=s,this.isDone=!1,this.requiredFiles=new Set,this.aliases=new Set,this.updateFiles=new Set,this.metadata=new Map,this.ignoredByPlugins=new Set,this._myImplementedHooks=null,this._cachedFile=null,this.outputPath=t,this.isVirtual||this.setDefaultFileHandle()}isIgnoredBy(e){return this.ignoredByPlugins.has(e)}addIgnoredPlugin(e){this.ignoredByPlugins.add(e)}createImplementedHooksMap(){var s;this._myImplementedHooks=new Map;for(const[i,n]of this.dash.plugins.getImplementedHooks()){const r=n.filter(l=>!this.isIgnoredBy(l.pluginId));this._myImplementedHooks.set(i,r)}((s=this.myImplementedHooks.get("read"))!=null?s:[]).length>0&&(this._cachedFile=this.dash.fileSystem.readFile(this.filePath).catch(()=>null))}get myImplementedHooks(){if(this._myImplementedHooks)return this._myImplementedHooks;throw new Error("Tried to access implemented hooks before they were created")}setFileHandle(e){this.fileHandle=e}setDefaultFileHandle(){this.setFileHandle({getFile:()=>this._cachedFile})}setOutputPath(e){this.outputPath=e}setReadData(e){this.data=e}setAliases(e){for(const t of e)this.dash.includedFiles.addAlias(t,this);this.aliases=e}setRequiredFiles(e){this.requiredFiles=e}addRequiredFile(e){this.requiredFiles.add(e)}setUpdateFiles(e){this.updateFiles=new Set(e.map(t=>this.dash.includedFiles.get(t)).filter(t=>t!==void 0))}addUpdateFile(e){this.updateFiles.add(e)}removeUpdateFile(e){this.updateFiles.delete(e)}setMetadata(e){typeof e=="object"&&(this.metadata=new Map(Object.entries(e)))}addMetadata(e,t){this.metadata.set(e,t)}deleteMetadata(e){this.metadata.delete(e)}getMetadata(e){return this.metadata.get(e)}getAllMetadata(){return Object.fromEntries(this.metadata.entries())}getHotUpdateChain(){const e=new Set([this]);for(const t of this.updateFiles)t.getHotUpdateChain().forEach(s=>{e.add(s)});return e}filesToLoadForHotUpdate(e=new Set,t=!0){const s=new Set;if(e.has(this))return s;e.add(this);for(const i of this.requiredFiles){const n=this.dash.includedFiles.query(i);for(const r of n)r.filesToLoadForHotUpdate(e,!1).forEach(l=>{s.add(l)})}if(s.add(this),t)for(const i of this.updateFiles)i.filesToLoadForHotUpdate(e,!0).forEach(n=>{s.add(n)});return s}processAfterLoad(e,t){(this.data===null||this.data===void 0)&&(this.isDone=!0,this.filePath!==this.outputPath&&this.outputPath!==null&&!this.isVirtual&&e&&t.push(this.dash.fileSystem.copyFile(this.filePath,this.outputPath,this.dash.outputFileSystem)))}serialize(){return{isVirtual:this.isVirtual,filePath:this.filePath,aliases:[...this.aliases],requiredFiles:[...this.requiredFiles],updateFiles:[...this.updateFiles].map(e=>e.filePath),metadata:this.metadata.size>0?Object.fromEntries(this.metadata.entries()):void 0}}reset(){this.isDone=!1,this.data=null,this._myImplementedHooks=null,this._cachedFile=null,this.isVirtual||this.setDefaultFileHandle()}}class Oe{constructor(e){this.dash=e,this.files=new Map,this.aliases=new Map,this.queryCache=new Map}all(){return[...this.files.values()]}filtered(e){return this.all().filter(t=>e(t))}get(e){var t;return(t=this.aliases.get(e))!=null?t:this.files.get(e)}getFromFilePath(e){return this.files.get(e)}query(e){const t=this.aliases.get(e);if(t)return[t];const s=this.files.get(e);return s?[s]:re.default(e)?this.queryGlob(e):[]}addAlias(e,t){this.aliases.set(e,t)}queryGlob(e){if(this.queryCache.has(e))return this.queryCache.get(e);const t=this.filtered(s=>C.isMatch(s.filePath,e));return this.queryCache.set(e,t),t}async loadAll(){this.dash.console.time("Load all files"),this.queryCache=new Map;const e=new Set,t=this.dash.projectConfig.getAvailablePackPaths(),s=[];for(const n of t)s.push(this.dash.fileSystem.allFiles(n).catch(r=>(this.dash.console.warn(r),[])).then(r=>{for(const l of r)e.add(l)}));await Promise.all(s);const i=await this.dash.plugins.runIncludeHooks();for(const n of i)typeof n=="string"?e.add(n):this.addOne(n[0],n[1].isVirtual);this.add([...e]),this.dash.console.timeEnd("Load all files")}addOne(e,t=!1){const s=new P(this.dash,e,t);return this.files.set(e,s),s}add(e,t=!1){let s=[];for(const i of e){const n=this.files.get(i);if(n){s.push(n);continue}s.push(new P(this.dash,i,t)),this.files.set(i,s[s.length-1])}return s}remove(e){const t=this.files.get(e);if(!!t){this.files.delete(e);for(const s of t.aliases)this.aliases.delete(s)}}async save(e){await this.dash.fileSystem.writeJson(e,this.all().map(t=>t.serialize()))}async load(e){this.removeAll();const t=await this.dash.fileSystem.readJson(e).catch(()=>null),s=[];if(!!t){for(const i of t){const n=new P(this.dash,i.filePath,i.isVirtual);n.setAliases(new Set(i.aliases)),n.setRequiredFiles(new Set(i.requiredFiles)),n.setMetadata(i.metadata),s.push(n);for(const r of i.aliases)this.aliases.set(r,n)}this.files=new Map(s.map(i=>[i.filePath,i]));for(let i=0;i<s.length;i++)s[i].setUpdateFiles(t[i].updateFiles)}}resetAll(){for(const e of this.all())e.reset()}removeAll(){this.files=new Map,this.aliases=new Map,this.queryCache=new Map}}class Ee{constructor(e){this.dash=e,this.copyFilePromises=[]}async run(e,t=!0){this.copyFilePromises=[];let s=[];for(const i of e)i.isDone||s.push(this.loadFile(i,t));await Promise.allSettled(s)}async loadFile(e,t=!0){var u;const[s,i]=await Promise.all([this.dash.plugins.runIgnoreHooks(e),this.dash.plugins.runTransformPathHooks(e)]),n=await this.dash.plugins.runReadHooks(e);if(e.setOutputPath(i),e.setReadData(n),e.processAfterLoad(t,this.copyFilePromises),e.isDone)return;e.setReadData((u=await this.dash.plugins.runLoadHooks(e))!=null?u:e.data);const[r,l]=await Promise.all([this.dash.plugins.runRegisterAliasesHooks(e),this.dash.plugins.runRequireHooks(e)]);e.setAliases(r),e.setRequiredFiles(l)}async awaitAllFilesCopied(){this.copyFilePromises.length!==0&&(await Promise.allSettled(this.copyFilePromises),this.copyFilePromises=[])}}class Pe{constructor(e){this.dash=e}run(e){const t=new Set;for(const s of e)s.isDone||t.has(s)||this.resolveSingle(s,t);return t}resolveSingle(e,t,s=new Set){const i=this.dash.includedFiles;s.add(e);for(const n of e.requiredFiles){const r=i.query(n);for(const l of r){if(!l){this.dash.console.error(`Undefined file dependency: "${e.filePath}" requires "${n}"`);continue}if(l.addUpdateFile(e),!t.has(l)){if(s.has(l)){this.dash.console.error(`Circular dependency detected: ${l.filePath} is required by ${e.filePath} but also depends on this file.`);continue}this.resolveSingle(l,t,s)}}}t.add(e),s.delete(e)}}function qe(a){return typeof a=="string"||a instanceof Blob||a instanceof File||a instanceof ArrayBuffer||(a==null?void 0:a.buffer)instanceof ArrayBuffer}class Re{constructor(e){this.dash=e}async run(e,t=!1){const s=[];for(const i of e){if(i.isDone)continue;let n=await this.transformFile(i,!0,t);n!=null&&i.outputPath&&s.push(this.dash.outputFileSystem.writeFile(i.outputPath,n))}await Promise.allSettled(s)}async transformFile(e,t=!1,s=!1){var n;if(s||(e.data=(n=await this.dash.plugins.runTransformHooks(e))!=null?n:e.data),!t)return e.data;let i=await this.dash.plugins.runFinalizeBuildHooks(e);return i===void 0&&(i=e.data),i!=null&&(qe(i)||(this.dash.console.warn(`File "${e.filePath}" was not in a writable format: "${typeof i}". Trying to JSON.stringify(...) it...`,i),i=JSON.stringify(i))),e.isDone=!0,i}}class De{constructor(e=1){this.total=e,this.current=0,this.onChangeCbs=new Set}get percentage(){return this.current/this.total}onChange(e){return this.onChangeCbs.add(e),{dispose:()=>this.onChangeCbs.delete(e)}}setTotal(e){this.total=e,this.current=0,this.onChangeCbs.forEach(t=>t(this))}updateCurrent(e){this.current=e,this.onChangeCbs.forEach(t=>t(this))}advance(){this.current++,this.onChangeCbs.forEach(e=>e(this))}addToTotal(e){this.total+=e,this.onChangeCbs.forEach(t=>t(this))}}class ee{constructor(e=!1){this.verboseLogs=e,this._timers=new Map}time(e){if(!!this.verboseLogs)if(this._timers.has(e)){this.warn(`Timer "${e}" already exists.`);return}else this._timers.set(e,Date.now())}timeEnd(e){if(!this.verboseLogs)return;const t=this._timers.get(e);if(t)this._timers.delete(e),this.log(`${e}: ${Date.now()-t}ms`);else{this.warn(`Timer "${e}" does not exist.`);return}}}class te extends ee{constructor(e){super(e)}log(...e){console.log(...e)}error(...e){console.error(...e)}warn(...e){console.warn(...e)}info(...e){console.info(...e)}}class Ne{constructor(e,t,s){var i;this.fileSystem=e,this.options=s,this.progress=new De,this.plugins=new Me(this),this.includedFiles=new Oe(this),this.loadFiles=new Ee(this),this.fileOrderResolver=new Pe(this),this.fileTransformer=new Re(this),this.buildType="fullBuild",this.outputFileSystem=t!=null?t:e,this.projectRoot=j.dirname(s.config),this.projectConfig=new ae(e,s.config),this.console=(i=s.console)!=null?i:new te(s.verbose),this.jsRuntime=new Y(this.fileSystem,[["@molang/expressions",O.expressions],["@molang/core",{MoLang:O.MoLang}],["molang",{MoLang:O.MoLang,...O.expressions}],["@bridge/compiler",{mode:s.mode}]]),this.packType=s.packType,this.fileType=s.fileType}getMode(){var e;return(e=this.options.mode)!=null?e:"development"}getCompilerConfigPath(){return this.options.compilerConfig}get requestJsonData(){return this.options.requestJsonData}get dashFilePath(){return j.join(this.projectRoot,`.bridge/.dash.${this.getMode()}.json`)}async setup(e){var t,s,i,n;try{await this.projectConfig.setup()}catch(r){this.console.error("Failed to load project config: "+r)}(t=this.fileType)==null||t.setProjectConfig(this.projectConfig),(s=this.packType)==null||s.setProjectConfig(this.projectConfig),await((i=this.fileType)==null?void 0:i.setup(e)),await((n=this.packType)==null?void 0:n.setup(e)),await this.plugins.loadPlugins(this.options.pluginEnvironment)}async reload(){try{await this.projectConfig.refreshConfig()}catch{}await this.plugins.loadPlugins(this.options.pluginEnvironment)}get isCompilerActivated(){const e=this.projectConfig.get();return e.compiler!==void 0&&Array.isArray(e.compiler.plugins)}async build(){if(this.console.log("Starting compilation..."),!this.isCompilerActivated)return;this.jsRuntime.clearCache(),this.buildType="fullBuild",this.includedFiles.removeAll();const e=Date.now();this.progress.setTotal(7),this.console.time("[HOOK] Build start"),await this.plugins.runBuildStartHooks(),this.console.timeEnd("[HOOK] Build start"),this.progress.advance(),await this.includedFiles.loadAll(),this.progress.advance(),await this.compileIncludedFiles(),this.console.time("[HOOK] Build end"),await this.plugins.runBuildEndHooks(),this.console.timeEnd("[HOOK] Build end"),this.progress.advance(),this.getMode()==="development"&&await this.saveDashFile(),this.includedFiles.resetAll(),this.progress.advance(),this.console.log(`Dash compiled ${this.includedFiles.all().length} files in ${Date.now()-e}ms!`)}async updateFiles(e,t=!0){var l;if(!this.isCompilerActivated||e.length===0)return;this.buildType="hotUpdate",this.jsRuntime.clearCache(),this.progress.setTotal(8),this.console.log(`Dash is starting to update ${e.length} files...`),await this.includedFiles.load(this.dashFilePath),await this.plugins.runBuildStartHooks();const s=[];for(const u of e){let c=this.includedFiles.get(u);c||([c]=await this.includedFiles.add([u])),s.push(c)}this.progress.advance();const i=[];for(const u of s)i.push(new Set([...u.requiredFiles]));this.progress.advance(),await this.loadFiles.run(s),this.progress.advance();for(let u=0;u<s.length;u++){const c=s[u];[...c.requiredFiles].filter(d=>!i[u].has(d)).forEach(d=>this.includedFiles.query(d).forEach(w=>w.addUpdateFile(c))),[...i[u]].filter(d=>!c.requiredFiles.has(d)).forEach(d=>this.includedFiles.query(d).forEach(w=>w.removeUpdateFile(c)))}this.progress.advance();const n=new Set(s.map(u=>[...u.filesToLoadForHotUpdate()]).flat());this.console.log(`Dash is loading ${n.size} files...`),await this.loadFiles.run([...n.values()].filter(u=>!s.includes(u))),this.progress.advance();const r=new Set(s.map(u=>[...u.getHotUpdateChain()]).flat());for(const u of n)u.isDone||(u.data=(l=await this.plugins.runTransformHooks(u))!=null?l:u.data,r.has(u)||(u.isDone=!0));this.progress.advance(),this.console.log(`Dash is compiling ${r.size} files...`),await this.fileTransformer.run(r,!0),await this.loadFiles.awaitAllFilesCopied(),this.progress.advance(),await this.plugins.runBuildEndHooks(),t&&await this.saveDashFile(),this.includedFiles.resetAll(),this.console.log(`Dash finished updating ${r.size} files!`),this.progress.advance()}async compileFile(e,t){var r;if(!this.isCompilerActivated)return[[],t];this.buildType="fileRequest",this.jsRuntime.clearCache(),this.progress.setTotal(7),await this.plugins.runBuildStartHooks(),await this.includedFiles.load(this.dashFilePath);let s=this.includedFiles.get(e);s||([s]=await this.includedFiles.add([e])),s.setFileHandle({getFile:async()=>new File([t],j.basename(e))}),await this.loadFiles.loadFile(s,!1),this.progress.advance();const i=s.filesToLoadForHotUpdate();await this.loadFiles.run([...i.values()].filter(l=>s!==l),!1),this.progress.advance();for(const l of i)l.isDone||(l.data=(r=await this.plugins.runTransformHooks(l))!=null?r:l.data);this.progress.advance();const n=await this.fileTransformer.transformFile(s,!0,!0);return this.progress.advance(),await this.includedFiles.load(this.dashFilePath),this.progress.advance(),await this.plugins.runBuildEndHooks(),[[...i].map(l=>l.filePath),n]}async unlinkMultiple(e,t=!0,s=!1){if(!this.isCompilerActivated||e.length===0)return;const i=[];for(const n of e)await this.unlink(n,!1,s).catch(r=>i.push(r));if(i.length>0)throw i[0];t&&await this.saveDashFile()}async unlink(e,t=!0,s=!1){if(!this.isCompilerActivated)return;const i=await this.getCompilerOutputPath(e);!i||i===e||(s||(await this.plugins.runBeforeFileUnlinked(e),this.includedFiles.remove(e)),await this.outputFileSystem.unlink(i),t&&await this.saveDashFile())}async rename(e,t){!this.isCompilerActivated||(await this.unlink(e,!1),await this.updateFiles([t],!1),await this.saveDashFile())}async getCompilerOutputPath(e){var i,n;if(!this.isCompilerActivated)return;const t=(i=this.includedFiles.get(e))!=null?i:new P(this,e);if(t&&t.outputPath!==e)return(n=t.outputPath)!=null?n:void 0;const s=await this.plugins.runTransformPathHooks(t);if(!!s)return s}async getFileMetadata(e){if(!this.isCompilerActivated)return;const t=this.includedFiles.get(e);return t?t.getAllMetadata():null}async getFileDependencies(e){if(!this.isCompilerActivated)return[];await this.includedFiles.load(this.dashFilePath);const t=this.includedFiles.get(e);return t?[...t.filesToLoadForHotUpdate()].map(s=>s.isVirtual?s.outputPath:s.filePath).filter(s=>s!==null&&s!==e):[]}async saveDashFile(){await this.includedFiles.save(this.dashFilePath)}async compileIncludedFiles(e=this.includedFiles.all()){this.console.time("Loading files..."),await this.loadFiles.run(e),this.console.timeEnd("Loading files..."),this.progress.advance(),this.console.time("Resolving file order...");const t=this.fileOrderResolver.run(e);this.console.timeEnd("Resolving file order..."),this.progress.advance(),this.console.time("Transforming files..."),await this.fileTransformer.run(t),this.console.timeEnd("Transforming files..."),this.progress.advance(),await this.loadFiles.awaitAllFilesCopied()}async compileAdditionalFiles(e,t=!0){const s=await this.includedFiles.add(e,t);this.progress.addToTotal(3),s.forEach(i=>i.reset()),await this.compileIncludedFiles(s)}}class xe{async allFiles(e){const t=[],s=await this.readdir(e);for(const{name:i,kind:n}of s)n==="directory"?t.push(...await this.allFiles(j.join(e,i))):n==="file"&&t.push(j.join(e,i));return t}async directoryHasAnyFile(e){return(await this.readdir(e).catch(()=>[])).length>0}async copyFile(e,t,s=this){const i=await this.readFile(e);await s.writeFile(t,new Uint8Array(await i.arrayBuffer()))}async writeJson(e,t,s=!0){await this.writeFile(e,JSON.stringify(t,null,s?"	":0))}async readJson(e){const t=await this.readFile(e);try{return await T.default.parse(await t.text())}catch{throw new Error(`Invalid JSON: ${e}`)}}watchDirectory(e,t){console.warn("Watching a directory for changes is not supported on this platform!")}}Object.defineProperty(A,"initRuntimes",{enumerable:!0,get:function(){return D.initRuntimes}}),A.Command=E,A.Component=Q,A.Console=ee,A.Dash=Ne,A.DefaultConsole=te,A.FileSystem=xe,Object.defineProperty(A,"__esModule",{value:!0}),A[Symbol.toStringTag]="Module"});
